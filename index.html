<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nin Online Tournaments - Hawk Server</title>
    <!-- ADICIONADO ID para o script encontrar e alterar o favicon -->
    <link rel="icon" type="image/png" href="./icon.png" id="dynamic-favicon">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React Core -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel para traduzir JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useLayoutEffect } = React;

        // --- ÍCONES SVG INTEGRADOS ---
        const IconBase = ({ children, className, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );
        const Trophy = (props) => <IconBase {...props}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></IconBase>;
        const Swords = (props) => <IconBase {...props}><polyline points="14.5 17.5 3 6 3 3 6 3 17.5 14.5"/><line x1="13" x2="19" y1="19" y2="13"/><line x1="16" x2="20" y1="16" y2="20"/><line x1="19" x2="21" y1="21" y2="19"/></IconBase>;
        const Users = (props) => <IconBase {...props}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></IconBase>;
        const Medal = (props) => <IconBase {...props}><circle cx="12" cy="17" r="5"/><path d="M9 17v-8"/><path d="M15 17v-8"/><path d="M9 17h6"/><path d="M12 2v5"/><path d="M12 2l-4 5"/><path d="M12 2l4 5"/></IconBase>;
        const TrendingUp = (props) => <IconBase {...props}><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></IconBase>;
        const Search = (props) => <IconBase {...props}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></IconBase>;
        const Calendar = (props) => <IconBase {...props}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></IconBase>;
        const Clock = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconBase>;
        const XIcon = (props) => <IconBase {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>;
        const Filter = (props) => <IconBase {...props}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></IconBase>;
        const ChevronDown = (props) => <IconBase {...props}><path d="m6 9 6 6 6-6"/></IconBase>;
        const ChevronLeft = (props) => <IconBase {...props}><path d="m15 18-6-6 6-6"/></IconBase>;
        const ChevronRight = (props) => <IconBase {...props}><path d="m9 18 6-6-6-6"/></IconBase>;
        const ArrowRight = (props) => <IconBase {...props}><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></IconBase>;
        const Loader2 = (props) => <IconBase {...props}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></IconBase>;
        const AlertCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconBase>;
        const ServerIcon = (props) => <IconBase {...props}><rect x="2" y="2" width="20" height="8" rx="2" ry="2"/><rect x="2" y="14" width="20" height="8" rx="2" ry="2"/><line x1="6" x2="6.01" y1="6" y2="6"/><line x1="6" x2="6.01" y1="18" y2="18"/></IconBase>;
        const InfoIcon = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="16" y2="12"/><line x1="12" x2="12.01" y1="8" y2="8"/></IconBase>;
        const Menu = (props) => <IconBase {...props}><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></IconBase>;
        const TrendingDown = (props) => <IconBase {...props}><polyline points="22 17 13.5 8.5 8.5 13.5 2 7"/><polyline points="16 17 22 17 22 11"/></IconBase>;
        const ShieldCheck = (props) => <IconBase {...props}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="m9 12 2 2 4-4"/></IconBase>;
        const GitBranch = (props) => <IconBase {...props}><line x1="6" x2="6" y1="3" y2="15"/><circle cx="18" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><path d="M18 9a9 9 0 0 1-9 9"/></IconBase>;
        const HelpCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></IconBase>;
        const BookOpen = (props) => <IconBase {...props}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></IconBase>;
        const MapIcon = (props) => <IconBase {...props}><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></IconBase>;
        const Layers = (props) => <IconBase {...props}><path d="m12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83Z"/><path d="m22 17.65-9.17 4.16a2 2 0 0 1-1.66 0L2 17.65"/><path d="m22 12.65-9.17 4.16a2 2 0 0 1-1.66 0L2 12.65"/></IconBase>;
        const AlertTriangle = (props) => <IconBase {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></IconBase>;
        const Crosshair = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="22" y1="12" x2="18" y2="12"/><line x1="6" y1="12" x2="2" y2="12"/><line x1="12" y1="6" x2="12" y2="2"/><line x1="12" y1="22" x2="12" y2="18"/></IconBase>;
        const Skull = (props) => <IconBase {...props}><circle cx="9" cy="12" r="1"/><circle cx="15" cy="12" r="1"/><path d="M8 20v2h8v-2"/><path d="m12.5 17-.5-1-.5 1h1z"/><path d="M16 20a2 2 0 0 0 1.56-3.25 8 8 0 1 0-11.12 0A2 2 0 0 0 8 20"/></IconBase>;
        const Award = (props) => <IconBase {...props}><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></IconBase>;
        
        // Ícone de Fogo Atualizado (Visual mais realista)
        const Flame = (props) => <IconBase {...props} fill="currentColor"><path d="M12 2c0 0-3 2.5-3 6 0 2 1.5 3 1.5 5S9 19 12 19s4.5-3.5 4.5-6-1.5-3-1.5-5-3-6-3-6zm0 15c-1.5 0-2.5-1.5-2.5-3.5S10.5 11 12 11s2.5 1.5 2.5 2.5S13.5 17 12 17z" /><path d="M12 22c4.97 0 9-4.03 9-9 0-4-3-8-3-8s-1 3-2 4c0 0-1-2-2-4 0 0-1 3-3 5-1.5 1.5-3 1.5-3 1.5s-1.5 0-3-1.5c-2-2-3-5-3-5 0 0-2 2-2 4 0 4.97 4.03 9 9 9z" opacity="0.4"/></IconBase>;
        
        // Ícone de Estrela (Elite)
        const Star = (props) => <IconBase {...props}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" fill="currentColor" fillOpacity="0.2" /></IconBase>;

        // NOVOS ÍCONES NINJA
        const ShurikenIcon = (props) => <IconBase {...props}><path d="M12 2L14.5 9.5L22 12L14.5 14.5L12 22L9.5 14.5L2 12L9.5 9.5L12 2Z" fill="currentColor" fillOpacity="0.2" /></IconBase>;
        const ScrollIcon = (props) => <IconBase {...props}><path d="M19 4H9C7.89543 4 7 4.89543 7 6V20C7 21.1046 7.89543 22 9 22H19C20.1046 22 21 21.1046 21 20V6C21 4.89543 20.1046 4 19 4Z" /><path d="M5 15H4C3.44772 15 3 14.5523 3 14V8C3 7.44772 3.44772 7 4 7H5" /><path d="M15 12H19" /><path d="M15 16H19" /><path d="M15 8H19" /></IconBase>;


        // --- CONFIGURAÇÃO ---
        const CUSTOM_ICON_URL = './icon.png'; 
        const PLAYERS_FILE = './players.json'; // Arquivo de metadados dos jogadores
        const PRIORITY_MODES = ['Auto1v1', 'Auto2v2', 'Auto3v3', 'DBE1v1', 'DBE2v2'];
        
        // Cores e Estilos para Vilas e Maestrias
        const STYLE_MAP = {
            'Fogo': 'bg-red-500/20 text-red-400 border-red-500/30',
            'Água': 'bg-blue-500/20 text-blue-400 border-blue-500/30',
            'Terra': 'bg-amber-700/20 text-amber-500 border-amber-700/30',
            'Vento': 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30',
            'Raio': 'bg-yellow-500/20 text-yellow-400 border-yellow-500/30',
            'Médico': 'bg-pink-500/20 text-pink-400 border-pink-500/30',
            'Arma': 'bg-slate-500/20 text-slate-400 border-slate-500/30',
            'Taijutsu': 'bg-orange-500/20 text-orange-400 border-orange-500/30',
            'Leque': 'bg-cyan-500/20 text-cyan-400 border-cyan-500/30',
            'Bolha': 'bg-indigo-400/20 text-indigo-300 border-indigo-400/30',
            'Punho Gentil': 'bg-white/10 text-slate-200 border-white/20',
            
            'Folha': 'text-green-400',
            'Areia': 'text-yellow-500',
            'Névoa': 'text-blue-400',
            'Renegado Folha': 'text-slate-400',
            'Renegado Areia': 'text-slate-400',
            'Renegado Névoa': 'text-slate-400',
        };

        const MODE_DESCRIPTIONS = {
            'Geral': 'Visão completa de todas as partidas registradas no servidor, incluindo eventos e ranqueadas.',
            'Ranked': 'Soma exclusiva das filas ranqueadas automáticas (Auto1v1, Auto2v2 e Auto3v3).',
            'Auto1v1': 'Partidas ranqueadas automatizadas no formato 1 contra 1.',
            'Auto2v2': 'Partidas ranqueadas automatizadas no formato 2 contra 2.',
            'Auto3v3': 'Partidas ranqueadas automatizadas no formato 3 contra 3.',
            'DBE1v1': 'Dodge Ball Event (Queimada) no formato 1v1.',
            'DBE2v2': 'Dodge Ball Event (Queimada) no formato 2v2.',
            'Default': 'Estatísticas detalhadas para este modo de jogo específico.'
        };

        // --- COMPONENTE Skeleton ---
        const Skeleton = ({ className }) => <div className={`animate-pulse bg-slate-800 rounded ${className}`}></div>;

        // --- LÓGICA DO APLICATIVO ---

        const processBattleLogs = (data) => {
            const stats = {};
            const history = {};
            const rivalry = {}; // Armazena { Player: { Opponent: { wins: 0, losses: 0 } } }
            
            const initPlayer = (name) => {
                if (!stats[name]) {
                    stats[name] = { 
                        name, 
                        wins: 0, 
                        losses: 0, 
                        battles: 0, 
                        winRate: 0, 
                        modes: {},
                        streak: 0, // > 0 win streak, < 0 loss streak
                        maxStreak: 0,
                        badges: []
                    };
                    history[name] = [];
                    rivalry[name] = {};
                }
            };

            const updateModeStats = (playerName, mode, result) => {
                if (!stats[playerName].modes[mode]) {
                    stats[playerName].modes[mode] = { wins: 0, losses: 0, battles: 0 };
                }
                stats[playerName].modes[mode].battles += 1;
                if (result === 'win') stats[playerName].modes[mode].wins += 1;
                else stats[playerName].modes[mode].losses += 1;
            };

            const updateRivalry = (player, opponent, result) => {
                if (!rivalry[player][opponent]) rivalry[player][opponent] = { wins: 0, losses: 0 };
                if (result === 'win') rivalry[player][opponent].wins += 1;
                else rivalry[player][opponent].losses += 1;
            }

            if (!Array.isArray(data)) return { rankings: [], history: {} };
            
            // Ordenar por data para calcular Streak corretamente (Antigo -> Recente)
            const sortedData = [...data].sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));

            sortedData.forEach(log => {
                const content = log.content || "";
                const match = content.match(/^\[(.*?)\] (.*?) derrotou (.*)/);

                if (match) {
                    const mode = match[1]; 
                    const winnersPart = match[2];
                    const losersPart = match[3];
                    const timestamp = log.timestamp;

                    const winners = winnersPart.split(',').map(n => n.trim()).filter(n => n.length > 0);
                    const losers = losersPart.split(',').map(n => n.trim()).filter(n => n.length > 0);

                    winners.forEach(winner => {
                        initPlayer(winner);
                        stats[winner].wins += 1;
                        stats[winner].battles += 1;
                        updateModeStats(winner, mode, 'win');
                        history[winner].push({ opponent: losers.join(', '), result: 'win', timestamp: timestamp, mode: mode });
                        
                        // Streak Logic
                        if (stats[winner].streak >= 0) stats[winner].streak += 1;
                        else stats[winner].streak = 1;

                        losers.forEach(loser => updateRivalry(winner, loser, 'win'));
                    });

                    losers.forEach(loser => {
                        initPlayer(loser);
                        stats[loser].losses += 1;
                        stats[loser].battles += 1;
                        updateModeStats(loser, mode, 'loss');
                        history[loser].push({ opponent: winners.join(', '), result: 'loss', timestamp: timestamp, mode: mode });
                        
                        // Streak Logic
                        if (stats[loser].streak <= 0) stats[loser].streak -= 1;
                        else stats[loser].streak = -1;

                        winners.forEach(winner => updateRivalry(loser, winner, 'loss'));
                    });
                }
            });

            const rankings = Object.values(stats).map(player => {
                // Calcular Nemesis e Vítima
                let nemesis = { name: null, count: 0 };
                let victim = { name: null, count: 0 };
                
                if (rivalry[player.name]) {
                    Object.entries(rivalry[player.name]).forEach(([opp, s]) => {
                        if (s.losses > nemesis.count) nemesis = { name: opp, count: s.losses };
                        if (s.wins > victim.count) victim = { name: opp, count: s.wins };
                    });
                }

                // Badges Logic
                const badges = [];
                // Ícone Shuriken Dourada para Ninja Mestre
                if (player.battles >= 1000) badges.push({ id: 'master', icon: ShurikenIcon, label: 'Ninja Mestre', color: 'text-yellow-400 drop-shadow-[0_0_3px_rgba(250,204,21,0.5)]' });
                else if (player.battles >= 100) badges.push({ id: 'veteran', icon: ShurikenIcon, label: 'Ninja Veterano', color: 'text-blue-400' });
                
                const wr = player.battles > 0 ? (player.wins / player.battles) * 100 : 0;
                // ÍCONE ALTERADO PARA STAR
                if (player.battles >= 20 && wr >= 70) badges.push({ id: 'elite', icon: Star, label: 'Elite', color: 'text-yellow-400' });

                return {
                    ...player,
                    winRate: wr.toFixed(1),
                    nemesis: nemesis.count > 0 ? nemesis : null,
                    victim: victim.count > 0 ? victim : null,
                    badges
                };
            }).sort((a, b) => b.wins - a.wins);

            return { rankings, history };
        };

        const Card = ({ title, value, icon: Icon, colorClass }) => (
            <div className="bg-slate-800 p-6 rounded-lg shadow-lg border border-slate-700 flex items-center space-x-4 animate-in fade-in duration-500">
                <div className={`p-3 rounded-full ${colorClass} bg-opacity-20`}>
                    <Icon className={`w-6 h-6 ${colorClass.replace('bg-', 'text-')}`} />
                </div>
                <div>
                    <p className="text-slate-400 text-sm font-medium">{title}</p>
                    <h3 className="text-2xl font-bold text-white">{value}</h3>
                </div>
            </div>
        );

        // --- COMPONENTE DE GRÁFICO SIMPLES ---
        const PlayerPerformanceChart = ({ matches }) => {
            const [hoveredStat, setHoveredStat] = useState(null);
            const [tooltipPos, setTooltipPos] = useState({ x: 0, y: 0 });
            const scrollRef = useRef(null);

            // Agrupar partidas por data (Ordenação Cronológica: Antigo -> Recente)
            const statsByDate = useMemo(() => {
                const groups = {};
                const sortedMatches = [...matches].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                
                sortedMatches.forEach(match => {
                    const date = new Date(match.timestamp).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                    if (!groups[date]) groups[date] = { date, wins: 0, losses: 0, total: 0 };
                    groups[date].total += 1;
                    if (match.result === 'win') groups[date].wins += 1;
                    else groups[date].losses += 1;
                });
                
                return Object.values(groups); 
            }, [matches]);

            // Rolagem automática para o final (direita) ao carregar
            useLayoutEffect(() => {
                if (scrollRef.current) {
                    setTimeout(() => {
                        if (scrollRef.current) {
                            scrollRef.current.scrollLeft = scrollRef.current.scrollWidth;
                        }
                    }, 50); 
                }
            }, [statsByDate]);

            // Handler para o mouse
            const handleMouseMove = (e) => {
                setTooltipPos({ x: e.clientX, y: e.clientY });
            };

            if (statsByDate.length === 0) return null;

            const maxVal = Math.max(...statsByDate.map(d => Math.max(d.wins, d.losses))); 

            return (
                <div className="bg-slate-950/50 rounded-xl p-4 border border-slate-800 mb-4 flex flex-col relative" >
                    {/* TOOLTIP FLUTUANTE (FIXO NA TELA PARA EVITAR CORTES) */}
                    {hoveredStat && (
                        <div 
                            className="fixed z-50 pointer-events-none bg-slate-800 border border-slate-600 text-slate-100 text-xs rounded px-3 py-2 shadow-xl flex flex-col gap-1 min-w-[100px]"
                            style={{ 
                                left: tooltipPos.x + 15, 
                                top: tooltipPos.y - 15,
                            }}
                        >
                            <span className="font-bold border-b border-slate-700 pb-1 mb-1">{hoveredStat.date}</span>
                            <div className="flex justify-between">
                                <span className="text-green-400 font-bold">Vitórias:</span>
                                <span>{hoveredStat.wins}</span>
                            </div>
                            <div className="flex justify-between">
                                <span className="text-red-400 font-bold">Derrotas:</span>
                                <span>{hoveredStat.losses}</span>
                            </div>
                        </div>
                    )}

                    <div className="flex justify-between items-start mb-4">
                        <h4 className="text-slate-400 text-xs font-bold uppercase flex items-center gap-2">
                            <TrendingUp className="w-4 h-4 text-yellow-500"/> Desempenho (Dia)
                        </h4>
                    </div>
                    
                    <div 
                        ref={scrollRef}
                        className="overflow-x-auto pb-2 scrollbar-thin scrollbar-thumb-slate-700 scrollbar-track-slate-800/50"
                        onMouseMove={handleMouseMove}
                    >
                        {/* ALTURA REDUZIDA DE h-48 PARA h-32 */}
                        <div className="flex items-end gap-3 h-32 px-2 min-w-max">
                            {statsByDate.map((stat, idx) => {
                                const winHeight = stat.wins > 0 ? Math.max((stat.wins / maxVal) * 100, 5) : 0;
                                const lossHeight = stat.losses > 0 ? Math.max((stat.losses / maxVal) * 100, 5) : 0;
                                
                                return (
                                    <div 
                                        key={idx} 
                                        className="flex flex-col items-center justify-end h-full w-12 min-w-[48px] group relative flex-shrink-0 cursor-default hover:bg-white/5 rounded transition-colors"
                                        onMouseEnter={() => setHoveredStat(stat)}
                                        onMouseLeave={() => setHoveredStat(null)}
                                    >
                                        <div className="w-full flex items-end justify-center gap-1 h-full px-1">
                                            {/* Barra de Vitórias */}
                                            <div className="flex-1 bg-slate-800/30 rounded-t-sm h-full flex items-end relative overflow-hidden">
                                                 <div 
                                                    style={{ height: `${winHeight}%` }} 
                                                    className={`w-full transition-all duration-300 ${
                                                        hoveredStat === stat ? 'bg-green-400' : 'bg-green-600'
                                                    }`}
                                                ></div>
                                            </div>

                                            {/* Barra de Derrotas */}
                                            <div className="flex-1 bg-slate-800/30 rounded-t-sm h-full flex items-end relative overflow-hidden">
                                                <div 
                                                    style={{ height: `${lossHeight}%` }} 
                                                    className={`w-full transition-all duration-300 ${
                                                        hoveredStat === stat ? 'bg-red-400' : 'bg-red-600'
                                                    }`}
                                                ></div>
                                            </div>
                                        </div>
                                        
                                        <span className={`text-[10px] mt-2 font-mono whitespace-nowrap transition-colors ${
                                            hoveredStat === stat ? 'text-white font-bold' : 'text-slate-500'
                                        }`}>{stat.date}</span>
                                    </div>
                                )
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        const TournamentBracketModal = ({ tournament, onClose }) => {
            if (!tournament) return null;

            // Organizar partidas em "Rounds" (Chaves)
            // Assumindo que a ordem é cronológica inversa (última = final)
            const matches = [...tournament.matches].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // Agrupamento heurístico simples:
            // Índice 0: Final
            // Índice 1-2: Semifinais
            // Índice 3-6: Quartas
            // Índice 7+: Classificatórias
            
            const rounds = {
                'Final': [matches[0]].filter(Boolean),
                'Semifinais': matches.slice(1, 3),
                'Quartas de Final': matches.slice(3, 7),
                'Classificatórias': matches.slice(7)
            };

            return (
                <div 
                    className="fixed inset-0 bg-black/90 backdrop-blur-sm flex justify-center items-center p-4 z-50"
                    onClick={onClose} // Fecha ao clicar fora
                >
                    <div 
                        className="bg-slate-900 w-full max-w-5xl rounded-2xl shadow-2xl border border-slate-700 overflow-hidden flex flex-col h-[90vh]"
                        onClick={(e) => e.stopPropagation()} // Impede o fechamento ao clicar dentro
                    >
                        <div className="p-6 border-b border-slate-700 flex justify-between items-center bg-slate-800/50">
                            <div>
                                <h2 className="text-2xl font-bold text-white flex items-center gap-3">
                                    <Trophy className="text-yellow-500 w-6 h-6" />
                                    {tournament.name}
                                </h2>
                                <p className="text-slate-400 text-sm mt-1">{tournament.date}</p>
                            </div>
                            <button onClick={onClose} className="p-2 hover:bg-slate-700 rounded-full transition-colors text-slate-400 hover:text-white">
                                <XIcon className="w-6 h-6" />
                            </button>
                        </div>

                        <div className="flex-1 overflow-y-auto p-6 scrollbar-thin bg-slate-950/50">
                            {Object.entries(rounds).map(([roundName, roundMatches]) => {
                                if (roundMatches.length === 0) return null;
                                return (
                                    <div key={roundName} className="mb-8 last:mb-0">
                                        <div className="flex items-center gap-4 mb-4">
                                            <div className="h-px bg-slate-700 flex-1"></div>
                                            <h3 className="text-yellow-500 font-bold uppercase tracking-widest text-sm">{roundName}</h3>
                                            <div className="h-px bg-slate-700 flex-1"></div>
                                        </div>
                                        
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-4">
                                            {roundMatches.map((match, idx) => (
                                                <div key={idx} className="bg-slate-900 border border-slate-800 rounded-lg p-4 flex flex-col items-center justify-center relative overflow-hidden group hover:border-slate-600 transition-colors">
                                                    {/* Vencedor */}
                                                    <div className="w-full flex justify-between items-center mb-2">
                                                        <span className="text-green-400 font-bold truncate flex-1">{match.winners.join(', ')}</span>
                                                        <Trophy className="w-4 h-4 text-yellow-500 ml-2" />
                                                    </div>
                                                    
                                                    <div className="w-full h-px bg-slate-800 my-1"></div>
                                                    
                                                    {/* Perdedor */}
                                                    <div className="w-full flex justify-between items-center mt-2 opacity-60">
                                                        <span className="text-red-400 font-medium truncate flex-1">{match.losers.join(', ')}</span>
                                                    </div>

                                                    <div className="absolute top-2 right-2 text-[10px] text-slate-600 bg-slate-950 px-1 rounded">
                                                        {new Date(match.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        // --- COMPONENTE: MasteryDetailsModal (Atualizado com colunas extras) ---
        const MasteryDetailsModal = ({ mastery, players, onClose, onPlayerClick }) => {
            return (
                <div 
                    className="fixed inset-0 bg-black/90 backdrop-blur-sm flex justify-center items-center p-4 z-50 animate-in fade-in duration-200"
                    onClick={onClose}
                >
                    <div 
                        className="bg-slate-900 w-full max-w-4xl rounded-2xl shadow-2xl border border-slate-700 overflow-hidden flex flex-col max-h-[90vh]"
                        onClick={(e) => e.stopPropagation()}
                    >
                        <div className="p-6 border-b border-slate-700 flex justify-between items-center bg-slate-800/50">
                            <div>
                                <h2 className="text-2xl font-bold text-white flex items-center gap-3">
                                    <BookOpen className="text-blue-400 w-6 h-6" />
                                    Jogadores com: {mastery}
                                </h2>
                                <p className="text-slate-400 text-sm mt-1">
                                    Listando {players.length} jogadores encontrados
                                </p>
                            </div>
                            <button onClick={onClose} className="p-2 hover:bg-slate-700 rounded-full transition-colors text-slate-400 hover:text-white">
                                <XIcon className="w-6 h-6" />
                            </button>
                        </div>

                        <div className="flex-1 overflow-y-auto p-0 scrollbar-thin bg-slate-950/50">
                             <table className="w-full text-left border-collapse">
                                <thead className="sticky top-0 bg-slate-900 z-10 shadow-md">
                                    <tr className="border-b border-slate-800 text-slate-400 text-xs font-bold uppercase tracking-wider">
                                        <th className="p-5">#</th>
                                        <th className="p-5">Jogador</th>
                                        <th className="p-5 text-center">Vitórias</th>
                                        <th className="p-5 text-center">Derrotas</th>
                                        <th className="p-5 text-center">Partidas</th>
                                        <th className="p-5 text-center">Win Rate</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-800">
                                    {players.map((player, index) => {
                                        let rankColor = "text-slate-500";
                                        let rankIcon = null;
                                        const rank = index + 1;
                                        if (rank === 1) { rankColor = "text-yellow-500"; rankIcon = <Trophy className="w-4 h-4 mx-auto" />; }
                                        if (rank === 2) { rankColor = "text-slate-300"; rankIcon = <Medal className="w-4 h-4 mx-auto" />; }
                                        if (rank === 3) { rankColor = "text-amber-700"; rankIcon = <Medal className="w-4 h-4 mx-auto" />; }

                                        return (
                                            <tr 
                                                key={player.name} 
                                                onClick={() => onPlayerClick(player)}
                                                className="hover:bg-slate-800/50 cursor-pointer transition-colors group"
                                            >
                                                <td className={`p-5 text-center font-bold ${rankColor} text-lg w-16`}>
                                                    {rankIcon || `#${rank}`}
                                                </td>
                                                <td className="p-5">
                                                    <div className="flex flex-col">
                                                        <span className="font-semibold text-white group-hover:text-yellow-400 transition-colors text-lg">
                                                            {player.name}
                                                        </span>
                                                        {player.meta && (player.meta.village || player.meta.mastery_1) && (
                                                            <div className="flex flex-wrap gap-1 mt-1">
                                                                {player.meta.village && (
                                                                    <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded border border-slate-700 bg-slate-800/50 uppercase tracking-wide ${STYLE_MAP[player.meta.village] || 'text-slate-400'}`}>
                                                                        {player.meta.village}
                                                                    </span>
                                                                )}
                                                                {player.meta.mastery_1 && (
                                                                    <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded border uppercase tracking-wide ${STYLE_MAP[player.meta.mastery_1] || 'bg-slate-800 text-slate-400 border-slate-700'}`}>
                                                                        {player.meta.mastery_1}
                                                                    </span>
                                                                )}
                                                                {player.meta.mastery_2 && (
                                                                    <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded border uppercase tracking-wide ${STYLE_MAP[player.meta.mastery_2] || 'bg-slate-800 text-slate-400 border-slate-700'}`}>
                                                                        {player.meta.mastery_2}
                                                                    </span>
                                                                )}
                                                            </div>
                                                        )}
                                                    </div>
                                                </td>
                                                {/* Cores Ajustadas: Amarelo, Vermelho, Azul */}
                                                <td className="p-5 text-center font-bold text-yellow-500">{player.wins}</td>
                                                <td className="p-5 text-center font-medium text-red-500">{player.losses}</td>
                                                <td className="p-5 text-center text-blue-400 font-bold">{player.battles}</td>
                                                <td className="p-5 text-center">
                                                     <span className={`text-xs font-bold px-2 py-1 rounded-full ${
                                                        parseFloat(player.winRate) >= 60 ? 'bg-green-500/20 text-green-400' : 
                                                        parseFloat(player.winRate) >= 40 ? 'bg-yellow-500/20 text-yellow-400' : 
                                                        'bg-red-500/20 text-red-400'
                                                    }`}>{player.winRate}%</span>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        // --- NOVO COMPONENTE: VillageDetailsModal ---
        const VillageDetailsModal = ({ village, players, onClose, onPlayerClick }) => {
            return (
                <div 
                    className="fixed inset-0 bg-black/90 backdrop-blur-sm flex justify-center items-center p-4 z-50 animate-in fade-in duration-200"
                    onClick={onClose}
                >
                    <div 
                        className="bg-slate-900 w-full max-w-4xl rounded-2xl shadow-2xl border border-slate-700 overflow-hidden flex flex-col max-h-[90vh]"
                        onClick={(e) => e.stopPropagation()}
                    >
                        <div className="p-6 border-b border-slate-700 flex justify-between items-center bg-slate-800/50">
                            <div>
                                <h2 className="text-2xl font-bold text-white flex items-center gap-3">
                                    <MapIcon className="text-yellow-500 w-6 h-6" />
                                    Jogadores da Vila: <span className={STYLE_MAP[village] || ''}>{village}</span>
                                </h2>
                                <p className="text-slate-400 text-sm mt-1">
                                    Listando {players.length} jogadores encontrados
                                </p>
                            </div>
                            <button onClick={onClose} className="p-2 hover:bg-slate-700 rounded-full transition-colors text-slate-400 hover:text-white">
                                <XIcon className="w-6 h-6" />
                            </button>
                        </div>

                        <div className="flex-1 overflow-y-auto p-0 scrollbar-thin bg-slate-950/50">
                             <table className="w-full text-left border-collapse">
                                <thead className="sticky top-0 bg-slate-900 z-10 shadow-md">
                                    <tr className="border-b border-slate-800 text-slate-400 text-xs font-bold uppercase tracking-wider">
                                        <th className="p-5">#</th>
                                        <th className="p-5">Jogador</th>
                                        <th className="p-5 text-center">Vitórias</th>
                                        <th className="p-5 text-center">Derrotas</th>
                                        <th className="p-5 text-center">Partidas</th>
                                        <th className="p-5 text-center">Win Rate</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-800">
                                    {players.map((player, index) => {
                                        let rankColor = "text-slate-500";
                                        let rankIcon = null;
                                        const rank = index + 1;
                                        if (rank === 1) { rankColor = "text-yellow-500"; rankIcon = <Trophy className="w-4 h-4 mx-auto" />; }
                                        if (rank === 2) { rankColor = "text-slate-300"; rankIcon = <Medal className="w-4 h-4 mx-auto" />; }
                                        if (rank === 3) { rankColor = "text-amber-700"; rankIcon = <Medal className="w-4 h-4 mx-auto" />; }

                                        return (
                                            <tr 
                                                key={player.name} 
                                                onClick={() => onPlayerClick(player)}
                                                className="hover:bg-slate-800/50 cursor-pointer transition-colors group"
                                            >
                                                <td className={`p-5 text-center font-bold ${rankColor} text-lg w-16`}>
                                                    {rankIcon || `#${rank}`}
                                                </td>
                                                <td className="p-5">
                                                    <div className="flex flex-col">
                                                        <span className="font-semibold text-white group-hover:text-yellow-400 transition-colors text-lg">
                                                            {player.name}
                                                        </span>
                                                        {player.meta && (player.meta.village || player.meta.mastery_1) && (
                                                            <div className="flex flex-wrap gap-1 mt-1">
                                                                {player.meta.village && (
                                                                    <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded border border-slate-700 bg-slate-800/50 uppercase tracking-wide ${STYLE_MAP[player.meta.village] || 'text-slate-400'}`}>
                                                                        {player.meta.village}
                                                                    </span>
                                                                )}
                                                                {player.meta.mastery_1 && (
                                                                    <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded border uppercase tracking-wide ${STYLE_MAP[player.meta.mastery_1] || 'bg-slate-800 text-slate-400 border-slate-700'}`}>
                                                                        {player.meta.mastery_1}
                                                                    </span>
                                                                )}
                                                                {player.meta.mastery_2 && (
                                                                    <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded border uppercase tracking-wide ${STYLE_MAP[player.meta.mastery_2] || 'bg-slate-800 text-slate-400 border-slate-700'}`}>
                                                                        {player.meta.mastery_2}
                                                                    </span>
                                                                )}
                                                            </div>
                                                        )}
                                                    </div>
                                                </td>
                                                {/* Cores Ajustadas: Amarelo, Vermelho, Azul */}
                                                <td className="p-5 text-center font-bold text-yellow-500">{player.wins}</td>
                                                <td className="p-5 text-center font-medium text-red-500">{player.losses}</td>
                                                <td className="p-5 text-center text-blue-400 font-bold">{player.battles}</td>
                                                <td className="p-5 text-center">
                                                     <span className={`text-xs font-bold px-2 py-1 rounded-full ${
                                                        parseFloat(player.winRate) >= 60 ? 'bg-green-500/20 text-green-400' : 
                                                        parseFloat(player.winRate) >= 40 ? 'bg-yellow-500/20 text-yellow-400' : 
                                                        'bg-red-500/20 text-red-400'
                                                    }`}>{player.winRate}%</span>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const InfoModal = ({ onClose }) => (
            <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex justify-center items-center p-4 z-50 animate-in fade-in duration-200" onClick={onClose}>
                <div className="bg-slate-900 w-full max-w-lg rounded-2xl shadow-2xl border border-slate-700 overflow-hidden flex flex-col" onClick={(e) => e.stopPropagation()}>
                    <div className="p-6 border-b border-slate-700 flex justify-between items-center bg-slate-800/50">
                        <h2 className="text-xl font-bold text-white flex items-center gap-2">
                            <HelpCircle className="w-5 h-5 text-blue-400" />
                            Como usar o site
                        </h2>
                        <button onClick={onClose} className="p-1.5 hover:bg-slate-700 rounded-full transition-colors text-slate-400 hover:text-white">
                            <XIcon className="w-5 h-5" />
                        </button>
                    </div>
                    <div className="p-6 text-slate-300 text-sm leading-relaxed space-y-4">
                        <div className="space-y-2">
                            <h3 className="text-yellow-500 font-bold uppercase text-xs tracking-wider">Funcionalidades</h3>
                            <ul className="list-disc pl-5 space-y-1 marker:text-slate-600">
                                <li><strong>Ranking:</strong> Veja os melhores jogadores do servidor. Clique em um nome para ver o histórico de partidas e gráficos de desempenho.</li>
                                <li><strong>Torneios:</strong> Acesse a lista de torneios passados. Clique em um torneio para visualizar as chaves (brackets) e o progresso das lutas.</li>
                                <li><strong>Filtros:</strong> Use os filtros de modo (Geral, Ranked, etc.) e data para refinar os resultados.</li>
                                <li><strong>Versus:</strong> Compare o desempenho direto entre dois jogadores.</li>
                            </ul>
                        </div>
                        
                        <div className="h-px bg-slate-800 w-full"></div>

                        <div className="space-y-2">
                            <h3 className="text-yellow-500 font-bold uppercase text-xs tracking-wider">Legenda de Ícones</h3>
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-2 text-xs">
                                <div className="flex items-center gap-2">
                                    <Flame className="w-4 h-4 text-orange-500" /> <span>3+ Vitórias Seguidas</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <Skull className="w-4 h-4 text-slate-500" /> <span>3+ Derrotas Seguidas</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <ShurikenIcon className="w-4 h-4 text-yellow-400 drop-shadow-[0_0_2px_rgba(250,204,21,0.8)]" /> <span>Ninja Mestre (1000+ partidas)</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <ShurikenIcon className="w-4 h-4 text-blue-400" /> <span>Ninja Veterano (100+ partidas)</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <Star className="w-4 h-4 text-yellow-400" /> <span>Elite (WR >= 70%)</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <Skull className="w-4 h-4 text-red-500" /> <span>Nêmesis (Quem mais te venceu)</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <Swords className="w-4 h-4 text-green-500" /> <span>Vítima (Quem você mais venceu)</span>
                                </div>
                            </div>
                        </div>

                        <div className="h-px bg-slate-800 w-full"></div>
                        <div className="space-y-2">
                            <h3 className="text-yellow-500 font-bold uppercase text-xs tracking-wider">Sobre o Projeto</h3>
                            <p>Este painel foi desenvolvido por <strong className="text-white">Auriosh</strong>.</p>
                            <p className="text-xs text-slate-500">É um projeto sem fins lucrativos e não remunerado, criado para a comunidade.</p>
                            <p className="text-xs text-slate-500">A atualização dos dados é feita manualmente através das informações divulgadas no canal oficial <span className="text-blue-400 bg-blue-900/30 px-1 rounded">Servidor</span> do Discord.</p>
                        </div>
                    </div>
                </div>
            </div>
        );

        const PlayerModal = ({ player, history, onClose, activeTab }) => {
            if (!player) return null;

            const allMatches = history[player.name] || [];
            
            const playerMatches = useMemo(() => {
                if (activeTab === 'Geral') return allMatches;
                if (activeTab === 'Ranked') {
                    return allMatches.filter(match => ['Auto1v1', 'Auto2v2', 'Auto3v3'].includes(match.mode));
                }
                return allMatches.filter(match => match.mode === activeTab);
            }, [allMatches, activeTab]);

            const sortedMatches = [...playerMatches].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            // CÁLCULO DE NEMESIS E VÍTIMA ESPECÍFICO DO MODO SELECIONADO (ActiveTab)
            const { localNemesis, localVictim } = useMemo(() => {
                const rivalryStats = {};
                
                playerMatches.forEach(match => {
                    const opp = match.opponent;
                    if (!rivalryStats[opp]) rivalryStats[opp] = { wins: 0, losses: 0 };
                    
                    if (match.result === 'win') rivalryStats[opp].wins++;
                    else rivalryStats[opp].losses++;
                });

                let bestVictim = { name: null, count: 0 };
                let worstNemesis = { name: null, count: 0 };

                Object.entries(rivalryStats).forEach(([name, stats]) => {
                    if (stats.wins > bestVictim.count) bestVictim = { name, count: stats.wins };
                    if (stats.losses > worstNemesis.count) worstNemesis = { name, count: stats.losses };
                });

                return { 
                    localNemesis: worstNemesis.count > 0 ? worstNemesis : null, 
                    localVictim: bestVictim.count > 0 ? bestVictim : null 
                };
            }, [playerMatches]);

            const matchesByDate = sortedMatches.reduce((groups, match) => {
                const date = match.timestamp 
                    ? new Date(match.timestamp).toLocaleDateString('pt-BR') 
                    : 'Data desconhecida';
                if (!groups[date]) {
                    groups[date] = [];
                }
                groups[date].push(match);
                return groups;
            }, {});

            return (
                <div 
                    className="fixed inset-0 bg-black/80 backdrop-blur-sm flex justify-center items-center p-4 z-[60]"
                    onClick={onClose} // Fecha ao clicar fora
                >
                    <div 
                        className="bg-slate-900 w-full max-w-6xl rounded-2xl shadow-2xl border border-slate-700 overflow-hidden flex flex-col h-[90vh]"
                        onClick={(e) => e.stopPropagation()} // Impede o fechamento ao clicar dentro
                    >
                        
                        <div className="p-6 border-b border-slate-700 flex justify-between items-start bg-slate-800/50 flex-shrink-0">
                            <div className="flex flex-col gap-2">
                                <h2 className="text-3xl font-bold text-white mb-0 flex items-center gap-2">
                                    {player.name}
                                    {parseFloat(player.winRate) >= 60 && <TrendingUp className="w-6 h-6 text-green-400" />}
                                </h2>
                                
                                <div className="flex flex-wrap gap-4 text-sm text-slate-400 items-center mt-1">
                                    <span className="bg-slate-800 px-2 py-0.5 rounded border border-slate-700 text-xs text-yellow-500 font-bold uppercase tracking-wider">
                                        {activeTab}
                                    </span>
                                    <span>{player.wins} Vitórias</span>
                                    <span>{player.losses} Derrotas</span>
                                    <span className={parseFloat(player.winRate) >= 50 ? 'text-green-400' : 'text-red-400'}>
                                        {player.winRate}% WR
                                    </span>

                                    {/* INDICADORES DE STREAK NO CABEÇALHO */}
                                    {player.streak >= 3 && (
                                        <div className="flex items-center gap-1.5 px-2 py-0.5 rounded bg-orange-900/30 border border-orange-500/30 shadow-sm ml-2" title="Sequência de Vitórias">
                                            <Flame className="w-3.5 h-3.5 text-orange-500" />
                                            <span className="text-[10px] font-bold text-orange-300 uppercase tracking-wide hidden sm:inline-block">Win Streak x{player.streak}</span>
                                        </div>
                                    )}
                                    {player.streak <= -3 && (
                                        <div className="flex items-center gap-1.5 px-2 py-0.5 rounded bg-red-900/30 border border-red-500/30 shadow-sm ml-2" title="Sequência de Derrotas">
                                            <Skull className="w-3.5 h-3.5 text-red-500" />
                                            <span className="text-[10px] font-bold text-red-300 uppercase tracking-wide hidden sm:inline-block">Loss Streak x{Math.abs(player.streak)}</span>
                                        </div>
                                    )}

                                    {/* LEGENDA DE CONQUISTAS (MOVIDA PARA LADO DO WR) */}
                                    {player.badges && player.badges.length > 0 && (
                                        <div className="flex items-center gap-2 pl-2 border-l border-slate-700">
                                            {player.badges.map((badge, idx) => (
                                                <div key={idx} className="flex items-center gap-1.5 px-2 py-0.5 rounded bg-slate-900 border border-slate-700 shadow-sm group relative" title={badge.label}>
                                                    <badge.icon className={`w-3.5 h-3.5 ${badge.color}`} />
                                                    <span className="text-[10px] font-bold text-slate-300 uppercase tracking-wide hidden sm:inline-block">{badge.label}</span>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                            <button onClick={onClose} className="text-slate-400 hover:text-white transition-colors p-2 hover:bg-slate-700 rounded-full">
                                <XIcon className="w-6 h-6" />
                            </button>
                        </div>

                        <div className="flex-1 overflow-hidden min-h-0">
                            <div className="h-full flex flex-col lg:flex-row-reverse">
                                <div className="w-full lg:w-[45%] p-4 lg:p-6 bg-slate-900 lg:border-l border-b lg:border-b-0 border-slate-800 overflow-y-auto lg:overflow-visible flex-shrink-0">
                                    <PlayerPerformanceChart matches={playerMatches} />

                                    <div className="bg-slate-950/30 p-4 rounded-xl border border-slate-800 w-full">
                                        <h4 className="text-slate-400 text-xs font-bold uppercase mb-3 flex items-center gap-2">
                                            <InfoIcon className="w-4 h-4 text-blue-500"/> Estatísticas Rápidas
                                        </h4>
                                        <div className="space-y-3 text-sm">
                                            <div className="flex justify-between text-slate-300">
                                                <span>Total Partidas</span>
                                                <span className="font-bold">{playerMatches.length}</span>
                                            </div>
                                            <div className="flex justify-between text-slate-300">
                                                <span>Taxa de Vitória</span>
                                                <span className={parseFloat(player.winRate) >= 50 ? 'text-green-400 font-bold' : 'text-red-400 font-bold'}>{player.winRate}%</span>
                                            </div>
                                            <div className="h-px bg-slate-800 my-1"></div>
                                            
                                            {/* Nêmesis e Vítima - USANDO CÁLCULO LOCAL (localNemesis/localVictim) */}
                                            {localNemesis && (
                                                <div className="flex justify-between items-center gap-4">
                                                    <span className="text-slate-400 flex items-center gap-1.5 flex-shrink-0">
                                                        <Skull className="w-3.5 h-3.5 text-red-500"/> Nêmesis
                                                    </span>
                                                    <div className="text-right overflow-hidden">
                                                        <span className="text-red-400 font-bold block leading-tight truncate" title={localNemesis.name}>{localNemesis.name}</span>
                                                        <span className="text-[10px] text-slate-600 whitespace-nowrap">{localNemesis.count} derrotas</span>
                                                    </div>
                                                </div>
                                            )}
                                            {localVictim && (
                                                <div className="flex justify-between items-center gap-4">
                                                    <span className="text-slate-400 flex items-center gap-1.5 flex-shrink-0">
                                                        <Swords className="w-3.5 h-3.5 text-green-500"/> Vítima
                                                    </span>
                                                    <div className="text-right overflow-hidden">
                                                        <span className="text-green-400 font-bold block leading-tight truncate" title={localVictim.name}>{localVictim.name}</span>
                                                        <span className="text-[10px] text-slate-600 whitespace-nowrap">{localVictim.count} vitórias</span>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>

                                <div className="w-full lg:w-[55%] flex flex-col h-full bg-slate-950/20">
                                    <div className="p-4 lg:p-6 pb-2 border-b border-slate-800 bg-slate-900/50 backdrop-blur-sm z-20 flex-shrink-0">
                                        <h3 className="text-lg font-bold text-white flex items-center gap-2">
                                            <Clock className="w-5 h-5 text-slate-500"/> Histórico de Batalhas
                                        </h3>
                                    </div>

                                    <div className="flex-1 overflow-y-auto p-4 lg:p-6 pt-0 scrollbar-thin relative">
                                        {Object.keys(matchesByDate).length > 0 ? (
                                            Object.entries(matchesByDate).map(([date, matches]) => (
                                                <div key={date} className="mb-6 last:mb-0">
                                                    {/* DATA NORMAL (NÃO STICKY): Agora rola com o conteúdo */}
                                                    <div className="bg-slate-900 border-b border-slate-800 py-2 mb-3 shadow-md">
                                                        <div className="flex items-center gap-2">
                                                            <Calendar className="w-4 h-4 text-yellow-500" />
                                                            <h4 className="text-slate-300 text-sm font-bold uppercase tracking-wider">{date}</h4>
                                                            <span className="text-xs text-slate-600 font-medium bg-slate-800 px-2 rounded-full border border-slate-700">{matches.length} partidas</span>
                                                        </div>
                                                    </div>
                                                    
                                                    <div className="space-y-2">
                                                        {matches.map((match, idx) => (
                                                            <div 
                                                                key={idx} 
                                                                className={`p-3 rounded-lg border flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 transition-all ${
                                                                    match.result === 'win' 
                                                                        ? 'bg-green-900/5 border-green-500/10 hover:bg-green-900/10' 
                                                                        : 'bg-red-900/5 border-red-500/10 hover:bg-red-900/10'
                                                                }`}
                                                            >
                                                                <div className="flex flex-col">
                                                                    <span className="text-[10px] font-bold uppercase tracking-wider text-slate-500 mb-0.5 flex items-center gap-1">
                                                                        {match.mode}
                                                                    </span>
                                                                    <div className="flex items-center gap-2 text-slate-200 text-sm font-medium">
                                                                        <span className={match.result === 'win' ? 'text-green-500 font-bold' : 'text-red-500 font-bold'}>
                                                                            {match.result === 'win' ? 'V' : 'D'}
                                                                        </span>
                                                                        <span className="text-slate-600">vs</span>
                                                                        <span>{match.opponent}</span>
                                                                    </div>
                                                                </div>
                                                                
                                                                <div className="text-right flex items-center gap-2 text-slate-500 text-xs">
                                                                    <span>
                                                                        {match.timestamp ? new Date(match.timestamp).toLocaleTimeString('pt-BR', {
                                                                            day: '2-digit',
                                                                            month: '2-digit',
                                                                            hour: '2-digit', 
                                                                            minute: '2-digit'
                                                                        }).replace(',', '') : '--:--'}
                                                                    </span>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            ))
                                        ) : (
                                            <div className="text-center py-10 text-slate-500">
                                                Nenhuma partida registrada neste filtro.
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [rawData, setRawData] = useState([]);
            const [playersMetadata, setPlayersMetadata] = useState({});
            const [data, setData] = useState({ rankings: [], history: {} });
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState(null);
            
            const [searchTerm, setSearchTerm] = useState('');
            const [sortConfig, setSortConfig] = useState({ key: 'wins', direction: 'desc' });
            const [activeTab, setActiveTab] = useState('Geral');
            const [selectedPlayer, setSelectedPlayer] = useState(null);
            
            // PAGINAÇÃO
            const [currentPage, setCurrentPage] = useState(1);
            const ITEMS_PER_PAGE = 50;

            const [timeFilter, setTimeFilter] = useState('current_month');
            const [availableMonths, setAvailableMonths] = useState([]);
            const [targetMonth, setTargetMonth] = useState('');
            const [dateRange, setDateRange] = useState({ start: null, end: null });
            
            const [showOtherModes, setShowOtherModes] = useState(false);
            const [viewMode, setViewMode] = useState('ranking'); 
            const [selectedTournament, setSelectedTournament] = useState(null);
            const [showInfoModal, setShowInfoModal] = useState(false);
            
            const [masteryViewMode, setMasteryViewMode] = useState('combined');
            const [selectedMastery, setSelectedMastery] = useState(null);
            const [selectedVillage, setSelectedVillage] = useState(null);

            // Versus State
            const [versusPlayer1, setVersusPlayer1] = useState('');
            const [versusPlayer2, setVersusPlayer2] = useState('');
            
            const [loadedFilesCount, setLoadedFilesCount] = useState(0);

            useEffect(() => {
                const favicon = document.getElementById('dynamic-favicon');
                if (favicon && CUSTOM_ICON_URL) {
                    favicon.href = CUSTOM_ICON_URL;
                }
            }, []);

            const getRoundedTime = (timestamp) => {
                const date = new Date(timestamp);
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes();
                const roundedMinutes = (Math.floor(minutes / 10) * 10).toString().padStart(2, '0');
                return `${hours}:${roundedMinutes}`;
            };

            // CARREGAMENTO DOS DADOS (LOGS E PLAYERS.JSON) - Otimizado em Paralelo
            useEffect(() => {
                const fetchData = async () => {
                    setIsLoading(true);
                    setError(null);
                    
                    const loadedData = [];
                    let page = 1;
                    let foundEnd = false;
                    const MAX_PAGES = 50; 
                    const BATCH_SIZE = 5; // Baixa 5 arquivos por vez

                    try {
                        // 1. Carregar Players Metadata
                        try {
                            const playersResp = await fetch(`${PLAYERS_FILE}?v=${Date.now()}`);
                            if (playersResp.ok) {
                                const playersJson = await playersResp.json();
                                const playersMap = {};
                                playersJson.forEach(p => {
                                    playersMap[p.name] = p;
                                });
                                setPlayersMetadata(playersMap);
                            }
                        } catch (err) {
                            console.warn("Erro ao carregar players.json:", err);
                        }

                        // 2. Carregar Logs em Paralelo
                        while (!foundEnd && page <= MAX_PAGES) {
                            const promises = [];
                            
                            // Cria lote de requisições
                            for (let i = 0; i < BATCH_SIZE; i++) {
                                const currentP = page + i;
                                if (currentP > MAX_PAGES) break;
                                
                                const url = `./servidor_page_${currentP}.json?v=${Date.now()}`;
                                promises.push(
                                    fetch(url)
                                    .then(res => {
                                        if (res.ok && res.headers.get('content-type')?.includes('application/json')) {
                                            return res.json();
                                        }
                                        return null;
                                    })
                                    .catch(() => null)
                                );
                            }

                            const results = await Promise.all(promises);
                            
                            let batchSuccessCount = 0;
                            results.forEach(json => {
                                if (Array.isArray(json)) {
                                    loadedData.push(...json);
                                    batchSuccessCount++;
                                } else {
                                    foundEnd = true; // Se um falhar no meio do lote, assumimos que acabou
                                }
                            });

                            if (batchSuccessCount === 0) foundEnd = true;
                            setLoadedFilesCount(prev => prev + batchSuccessCount);
                            
                            page += BATCH_SIZE;
                        }
                        
                        setRawData(loadedData);

                    } catch (err) {
                        console.error("Fetch error:", err);
                        setError(`Erro ao carregar dados: ${err.message}`);
                        setRawData([]); 
                    } finally {
                        setIsLoading(false);
                    }
                };
                fetchData();
            }, []);

            // Deep Linking Effect
            useEffect(() => {
                if (!isLoading && data.rankings.length > 0) {
                    const params = new URLSearchParams(window.location.search);
                    const playerParam = params.get('player');
                    if (playerParam) {
                        const found = data.rankings.find(p => p.name.toLowerCase() === playerParam.toLowerCase());
                        if (found) {
                            setSelectedPlayer(found);
                            // Limpar URL sem recarregar para não ficar preso no player
                            window.history.replaceState({}, document.title, window.location.pathname);
                        }
                    }
                }
            }, [isLoading, data.rankings]);

            useEffect(() => {
                if (rawData.length === 0) {
                    setData({ rankings: [], history: {} });
                    return;
                }

                const timestamps = rawData
                    .map(l => l.timestamp ? new Date(l.timestamp).getTime() : 0)
                    .filter(t => t > 0);
                
                if (timestamps.length > 0) {
                    const minTime = Math.min(...timestamps);
                    const maxTime = Math.max(...timestamps);
                    setDateRange({
                        start: new Date(minTime).toLocaleDateString('pt-BR'),
                        end: new Date(maxTime).toLocaleDateString('pt-BR')
                    });

                    const uniqueMonths = new Set();
                    timestamps.forEach(ts => {
                        const d = new Date(ts);
                        const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                        uniqueMonths.add(key);
                    });
                    const sortedMonths = Array.from(uniqueMonths).sort().reverse();
                    setAvailableMonths(sortedMonths);
                    
                    if (!targetMonth && sortedMonths.length > 0) {
                        setTargetMonth(sortedMonths[0]);
                    }
                }
            }, [rawData]);

            const referenceDate = useMemo(() => new Date(), []);

            const filteredLogs = useMemo(() => {
                return rawData.filter(log => {
                    if (timeFilter === 'all') return true;
                    if (!log.timestamp) return false;
                    
                    const logTime = new Date(log.timestamp).getTime();
                    const logDate = new Date(log.timestamp);
                    
                    if (timeFilter === 'current_month') {
                        return logDate.getMonth() === referenceDate.getMonth() && 
                               logDate.getFullYear() === referenceDate.getFullYear();
                    }

                    if (timeFilter === 'specific_month') {
                        if (!targetMonth) return true;
                        const [year, month] = targetMonth.split('-').map(Number);
                        return logDate.getMonth() + 1 === month && 
                               logDate.getFullYear() === year;
                    }

                    const diff = referenceDate.getTime() - logTime;
                    const oneDay = 24 * 60 * 60 * 1000;
                    
                    if (timeFilter === 'day') return diff <= oneDay && diff >= 0;
                    if (timeFilter === 'week') return diff <= 7 * oneDay && diff >= 0;
                    return true;
                });
            }, [rawData, timeFilter, targetMonth, referenceDate]);

            useEffect(() => {
                const processed = processBattleLogs(filteredLogs);
                const enrichedRankings = processed.rankings.map(r => ({
                    ...r,
                    meta: playersMetadata[r.name] || {}
                }));
                setData({ ...processed, rankings: enrichedRankings });
                setCurrentPage(1); // Resetar página ao filtrar
            }, [filteredLogs, playersMetadata]);

            const modeGroups = useMemo(() => {
                if (rawData.length === 0) return { main: ['Geral', 'Ranked'], others: [] };
                const modes = new Set();
                rawData.forEach(log => {
                    const match = (log.content || "").match(/^\[(.*?)\]/);
                    if (match) modes.add(match[1]);
                });
                
                const allFoundModes = Array.from(modes);
                const mainModes = ['Geral', 'Ranked', ...PRIORITY_MODES.filter(m => modes.has(m))];
                const otherModes = allFoundModes.filter(m => !PRIORITY_MODES.includes(m)).sort();
                
                return { main: mainModes, others: otherModes };
            }, [rawData]);

            // VERSUS LOGIC
            const versusMatches = useMemo(() => {
                if (!versusPlayer1 || !versusPlayer2 || viewMode !== 'versus') return [];
                
                return filteredLogs.filter(log => {
                    const content = log.content || "";
                    const match = content.match(/^\[(.*?)\] (.*?) derrotou (.*)/);
                    if (!match) return false;

                    const mode = match[1];
                    // Check activeTab for Versus mode as well
                    if (activeTab !== 'Geral') {
                        if (activeTab === 'Ranked') {
                             if (!['Auto1v1', 'Auto2v2', 'Auto3v3'].includes(mode)) return false;
                        } else {
                             if (mode !== activeTab) return false;
                        }
                    }
                    
                    const winnersStr = match[2];
                    const losersStr = match[3];
                    
                    const winners = winnersStr.split(',').map(n => n.trim());
                    const losers = losersStr.split(',').map(n => n.trim());
                    
                    const p1InWinners = winners.includes(versusPlayer1);
                    const p2InLosers = losers.includes(versusPlayer2);
                    const p2InWinners = winners.includes(versusPlayer2);
                    const p1InLosers = losers.includes(versusPlayer1);
                    
                    return (p1InWinners && p2InLosers) || (p2InWinners && p1InLosers);
                }).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            }, [filteredLogs, versusPlayer1, versusPlayer2, viewMode, activeTab]);

            const versusStats = useMemo(() => {
                let p1Wins = 0;
                let p2Wins = 0;
                
                versusMatches.forEach(log => {
                    const match = log.content.match(/^\[(.*?)\] (.*?) derrotou (.*)/);
                    const winners = match[2].split(',').map(n => n.trim());
                    if (winners.includes(versusPlayer1)) p1Wins++;
                    else p2Wins++;
                });
                
                return { p1Wins, p2Wins, total: versusMatches.length };
            }, [versusMatches, versusPlayer1]);


             const groupedTournaments = useMemo(() => {
                if (filteredLogs.length === 0) return [];
                
                const sortedLogs = [...filteredLogs].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                
                const tournaments = [];
                const GAP_THRESHOLD = 90 * 60 * 1000; 

                sortedLogs.forEach(log => {
                    const content = log.content || "";
                    const match = content.match(/^\[(.*?)\] (.*?) derrotou (.*)/);
                    if (match && log.timestamp) {
                        const mode = match[1];
                        
                        let isMatch = false;
                        if (activeTab === 'Geral') isMatch = true;
                        else if (activeTab === 'Ranked') {
                            if (['Auto1v1', 'Auto2v2', 'Auto3v3'].includes(mode)) isMatch = true;
                        } else if (mode === activeTab) {
                            isMatch = true;
                        }

                        if (!isMatch) return;

                        const logTime = new Date(log.timestamp).getTime();
                        let targetTournament = null;
                        
                        for (let i = tournaments.length - 1; i >= 0; i--) {
                            if (tournaments[i].name === mode) {
                                const lastMatchTime = tournaments[i].lastMatchTimestamp;
                                if (logTime - lastMatchTime <= GAP_THRESHOLD) {
                                    targetTournament = tournaments[i];
                                }
                                break; 
                            }
                        }

                        const winners = match[2].split(',').map(n => n.trim()).filter(n => n.length > 0);
                        const losers = match[3].split(',').map(n => n.trim()).filter(n => n.length > 0);
                        const matchData = { winners, losers, timestamp: log.timestamp };

                        if (targetTournament) {
                            targetTournament.matches.push(matchData);
                            targetTournament.lastMatchTimestamp = logTime; 
                        } else {
                            tournaments.push({
                                id: `${mode}-${log.timestamp}`, 
                                name: mode,
                                date: new Date(log.timestamp).toLocaleDateString('pt-BR'), 
                                timestamp: logTime, 
                                lastMatchTimestamp: logTime,
                                matches: [matchData]
                            });
                        }
                    }
                });

                return tournaments.sort((a, b) => b.lastMatchTimestamp - a.lastMatchTimestamp);
            }, [filteredLogs, activeTab]); 

            const tournamentsByDate = useMemo(() => {
                const groups = {};
                groupedTournaments.forEach(t => {
                    if (!groups[t.date]) groups[t.date] = [];
                    groups[t.date].push(t);
                });
                return groups;
            }, [groupedTournaments]);

            const filteredRankings = useMemo(() => {
                let players = [...data.rankings];

                if (activeTab === 'Geral') {
                } else if (activeTab === 'Ranked') {
                    players = players.map(p => {
                        let wins = 0, losses = 0, battles = 0;
                        const rankedModes = ['Auto1v1', 'Auto2v2', 'Auto3v3'];
                        
                        rankedModes.forEach(m => {
                            if (p.modes && p.modes[m]) {
                                wins += p.modes[m].wins;
                                losses += p.modes[m].losses;
                                battles += p.modes[m].battles;
                            }
                        });

                        if (battles === 0) return null;

                        return {
                            ...p,
                            wins,
                            losses,
                            battles,
                            winRate: ((wins / battles) * 100).toFixed(1)
                        };
                    }).filter(p => p !== null);
                } else {
                    players = players.map(p => {
                        const modeStats = p.modes && p.modes[activeTab];
                        if (!modeStats) return null;

                        return {
                            ...p,
                            wins: modeStats.wins,
                            losses: modeStats.losses,
                            battles: modeStats.battles,
                            winRate: modeStats.battles > 0 ? ((modeStats.wins / modeStats.battles) * 100).toFixed(1) : 0
                        };
                    }).filter(p => p !== null);
                }

                if (searchTerm) {
                    players = players.filter(p => p.name.toLowerCase().includes(searchTerm.toLowerCase()));
                }

                players.sort((a, b) => {
                    if (sortConfig.key === 'wins') {
                        if (a.wins !== b.wins) {
                            return sortConfig.direction === 'asc' ? a.wins - b.wins : b.wins - a.wins;
                        }
                        const wrA = parseFloat(a.winRate);
                        const wrB = parseFloat(b.winRate);
                        if (wrA !== wrB) {
                            return sortConfig.direction === 'asc' ? wrA - wrB : wrB - wrA;
                        }
                        return sortConfig.direction === 'asc' ? b.losses - a.losses : a.losses - b.losses;
                    }

                    let aValue = a[sortConfig.key];
                    let bValue = b[sortConfig.key];

                    if (!isNaN(parseFloat(aValue))) {
                        aValue = parseFloat(aValue);
                        bValue = parseFloat(bValue);
                    }

                    if (aValue < bValue) return sortConfig.direction === 'asc' ? -1 : 1;
                    if (aValue > bValue) return sortConfig.direction === 'asc' ? 1 : -1;
                    return 0;
                });

                return players;
            }, [data.rankings, searchTerm, sortConfig, activeTab]);

            // Paginação
            const paginatedRankings = useMemo(() => {
                const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
                return filteredRankings.slice(startIndex, startIndex + ITEMS_PER_PAGE);
            }, [filteredRankings, currentPage]);

            const totalPages = Math.ceil(filteredRankings.length / ITEMS_PER_PAGE);


            const groupedMasteries = useMemo(() => {
                const stats = {};
                
                const sourceData = filteredRankings; 

                if (masteryViewMode === 'individual') {
                    sourceData.forEach(p => {
                        if (p.meta && p.meta.mastery_1) {
                            const m1 = p.meta.mastery_1;
                            if (!stats[m1]) stats[m1] = { name: m1, parts: [m1], wins: 0, losses: 0, battles: 0, players: 0 };
                            stats[m1].wins += p.wins;
                            stats[m1].losses += p.losses;
                            stats[m1].battles += p.battles;
                            stats[m1].players += 1;
                        }
                        if (p.meta && p.meta.mastery_2) {
                            const m2 = p.meta.mastery_2;
                            if (!stats[m2]) stats[m2] = { name: m2, parts: [m2], wins: 0, losses: 0, battles: 0, players: 0 };
                            stats[m2].wins += p.wins;
                            stats[m2].losses += p.losses;
                            stats[m2].battles += p.battles;
                            stats[m2].players += 1;
                        }
                    });
                } else {
                    sourceData.forEach(p => {
                        if (p.meta && (p.meta.mastery_1 || p.meta.mastery_2)) {
                            const m1 = p.meta.mastery_1;
                            const m2 = p.meta.mastery_2;
                            let key;
                            let displayParts = [];
                            
                            if (m1 && m2) {
                                const parts = [m1, m2].sort();
                                key = parts.join(' + ');
                                displayParts = parts;
                            } else {
                                key = m1 || m2;
                                displayParts = [key];
                            }
                            
                            if (!stats[key]) stats[key] = { name: key, parts: displayParts, wins: 0, losses: 0, battles: 0, players: 0 };
                            stats[key].wins += p.wins;
                            stats[key].losses += p.losses;
                            stats[key].battles += p.battles;
                            stats[key].players += 1;
                        }
                    });
                }
                
                return Object.values(stats).map(stat => ({
                    ...stat,
                    winRate: stat.battles > 0 ? ((stat.wins / stat.battles) * 100).toFixed(1) : 0
                })).sort((a, b) => b.wins - a.wins);
            }, [filteredRankings, masteryViewMode]);

            const groupedVillages = useMemo(() => {
                const stats = {};
                filteredRankings.forEach(p => {
                    if (p.meta && p.meta.village) {
                        const v = p.meta.village;
                        if (!stats[v]) stats[v] = { name: v, wins: 0, losses: 0, battles: 0, players: 0 };
                        stats[v].wins += p.wins;
                        stats[v].losses += p.losses;
                        stats[v].battles += p.battles;
                        stats[v].players += 1;
                    }
                });
                return Object.values(stats).map(stat => ({
                    ...stat,
                    winRate: stat.battles > 0 ? ((stat.wins / stat.battles) * 100).toFixed(1) : 0
                })).sort((a, b) => b.wins - a.wins);
            }, [filteredRankings]);

            const handleSort = (key) => {
                let direction = 'desc';
                if (sortConfig.key === key && sortConfig.direction === 'desc') {
                    direction = 'asc';
                }
                setSortConfig({ key, direction });
            };

            const handleMasteryClick = (masteryName) => {
                setSelectedMastery(masteryName);
            };

            const handleVillageClick = (villageName) => {
                setSelectedVillage(villageName);
            };

            const selectedMasteryPlayers = useMemo(() => {
                if (!selectedMastery) return [];
                return filteredRankings.filter(p => {
                     if (masteryViewMode === 'individual') {
                         return p.meta?.mastery_1 === selectedMastery || p.meta?.mastery_2 === selectedMastery;
                     } else {
                         const m1 = p.meta?.mastery_1;
                         const m2 = p.meta?.mastery_2;
                         let key;
                         if (m1 && m2) {
                             key = [m1, m2].sort().join(' + ');
                         } else {
                             key = m1 || m2;
                         }
                         return key === selectedMastery;
                     }
                }).sort((a,b) => b.wins - a.wins);
            }, [selectedMastery, filteredRankings, masteryViewMode]);

            const selectedVillagePlayers = useMemo(() => {
                if (!selectedVillage) return [];
                return filteredRankings.filter(p => p.meta?.village === selectedVillage).sort((a,b) => b.wins - a.wins);
            }, [selectedVillage, filteredRankings]);


            const totalBattles = filteredRankings.reduce((acc, curr) => acc + curr.wins, 0); 

            const mostWinsPlayer = useMemo(() => {
                if (filteredRankings.length === 0) return null;
                return [...filteredRankings].sort((a,b) => {
                    if (b.wins !== a.wins) return b.wins - a.wins;
                    return parseFloat(b.winRate) - parseFloat(a.winRate);
                })[0];
            }, [filteredRankings]);

            const mostLossesPlayer = useMemo(() => {
                if (filteredRankings.length === 0) return null;
                return [...filteredRankings].sort((a,b) => {
                    if (b.losses !== a.losses) return b.losses - a.losses;
                    return parseFloat(a.winRate) - parseFloat(b.winRate);
                })[0];
            }, [filteredRankings]);

            if (isLoading) {
                return (
                    <div className="min-h-screen bg-slate-950 flex flex-col items-center justify-center p-8">
                        <div className="w-full max-w-md space-y-4">
                            <div className="flex justify-between items-end">
                                <div className="space-y-2">
                                    <Skeleton className="h-8 w-48" />
                                    <Skeleton className="h-4 w-32" />
                                </div>
                                <Loader2 className="w-8 h-8 animate-spin text-yellow-500" />
                            </div>
                            <Skeleton className="h-32 w-full rounded-xl" />
                            <div className="space-y-2">
                                <Skeleton className="h-12 w-full" />
                                <Skeleton className="h-12 w-full" />
                                <Skeleton className="h-12 w-full" />
                            </div>
                            <div className="text-center text-xs text-slate-500 pt-4">Carregando dados em paralelo... {loadedFilesCount} arquivos</div>
                        </div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="min-h-screen bg-slate-950 flex flex-col items-center justify-center text-red-400 p-8 text-center">
                        <AlertCircle className="w-16 h-16 mb-4" />
                        <h2 className="text-2xl font-bold mb-2">Erro ao carregar dados</h2>
                        <p className="max-w-md">{error}</p>
                        <div className="mt-6 p-4 bg-slate-900 rounded border border-slate-800 text-left text-sm text-slate-400">
                            <p className="font-bold text-yellow-500 mb-2">Como corrigir:</p>
                            <ul className="list-disc pl-5 space-y-1">
                                <li>Certifique-se de que existe pelo menos o arquivo <code>servidor_page_1.json</code> na pasta correta.</li>
                                <li>Se estiver no GitHub, verifique se os arquivos JSON subiram corretamente.</li>
                            </ul>
                        </div>
                        <button 
                            onClick={() => window.location.reload()}
                            className="mt-6 px-6 py-2 bg-slate-800 rounded-lg hover:bg-slate-700 transition-colors text-white"
                        >
                            Tentar Novamente
                        </button>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-slate-950 text-slate-100 font-sans p-4 md:p-8 pb-16"> 
                    {/* Modais */}
                    {showInfoModal && <InfoModal onClose={() => setShowInfoModal(false)} />}
                    
                    {selectedPlayer && (
                        <PlayerModal 
                            player={selectedPlayer} 
                            history={data.history} 
                            activeTab={activeTab}
                            onClose={() => setSelectedPlayer(null)} 
                        />
                    )}
                    
                    {selectedTournament && (
                        <TournamentBracketModal
                            tournament={selectedTournament}
                            onClose={() => setSelectedTournament(null)}
                        />
                    )}
                    
                    {selectedMastery && (
                        <MasteryDetailsModal 
                            mastery={selectedMastery}
                            players={selectedMasteryPlayers}
                            onClose={() => setSelectedMastery(null)}
                            onPlayerClick={(player) => {
                                setSelectedPlayer(player);
                            }}
                        />
                    )}
                    
                    {selectedVillage && (
                        <VillageDetailsModal 
                            village={selectedVillage}
                            players={selectedVillagePlayers}
                            onClose={() => setSelectedVillage(null)}
                            onPlayerClick={(player) => {
                                setSelectedPlayer(player);
                            }}
                        />
                    )}

                    <div className="max-w-7xl mx-auto space-y-8 animate-in fade-in slide-in-from-bottom-8 duration-700">
                        
                        {/* Header Principal */}
                        <div className="flex flex-col lg:flex-row justify-between items-center border-b border-slate-800 pb-6 gap-6 relative">
                            <div className="flex items-center gap-4 w-full lg:w-auto">
                                <img 
                                    src={CUSTOM_ICON_URL} 
                                    alt="Logo" 
                                    className="w-20 h-20 object-cover rounded-2xl" 
                                    onError={(e) => {
                                        e.target.style.display = 'none';
                                        e.target.nextSibling.style.display = 'flex';
                                    }}
                                />
                                <div className="hidden bg-gradient-to-br from-yellow-500 to-orange-600 p-4 rounded-2xl shadow-lg shadow-orange-500/20 flex items-center justify-center w-20 h-20">
                                    <Trophy className="w-10 h-10 text-white" />
                                </div>
                                
                                <div className="flex flex-col gap-1">
                                    <div className="flex items-center gap-3">
                                        <h1 className="text-4xl font-black text-white tracking-tight">
                                            Nin Online <span className="text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-orange-500">Tournaments</span>
                                        </h1>
                                        <button 
                                            onClick={() => setShowInfoModal(true)}
                                            className="bg-slate-800 p-1.5 rounded-full hover:bg-slate-700 transition-colors text-slate-400 hover:text-blue-400 border border-slate-700"
                                            title="Como usar / Sobre"
                                        >
                                            <HelpCircle className="w-5 h-5" />
                                        </button>
                                    </div>
                                    
                                    <div className="flex flex-wrap gap-2 mt-1">
                                        <div className="inline-flex items-center gap-1.5 px-3 py-1 bg-slate-800 rounded-full border border-slate-700 text-xs font-bold text-slate-300">
                                            <ServerIcon className="w-3 h-3 text-blue-400" />
                                            <span>Servidor: Hawk</span>
                                        </div>
                                        {dateRange.start && (
                                            <div className="inline-flex items-center gap-1.5 px-3 py-1 bg-slate-800 rounded-full border border-slate-700 text-xs font-bold text-slate-300">
                                                <Calendar className="w-3 h-3 text-yellow-500" />
                                                <span>{dateRange.start} até {dateRange.end}</span>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                            
                            {/* Banner de Contribuição - Integrado no Header */}
                            <div className="w-full lg:w-auto bg-gradient-to-r from-blue-900/40 to-slate-900/40 border border-blue-500/30 rounded-2xl p-4 flex flex-col sm:flex-row items-center gap-4 relative overflow-hidden group shadow-lg shadow-blue-900/10">
                                <div className="flex items-center gap-3 z-10">
                                    <div className="bg-blue-500/20 p-2.5 rounded-full hidden xl:block group-hover:scale-110 transition-transform duration-300">
                                        <BookOpen className="w-5 h-5 text-blue-400" />
                                    </div>
                                    <div className="flex flex-col">
                                        <h3 className="text-white font-bold text-sm flex items-center gap-2">
                                            Contribua com a Comunidade!
                                            <span className="flex h-2 w-2 relative">
                                                <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span>
                                                <span className="relative inline-flex rounded-full h-2 w-2 bg-blue-500"></span>
                                            </span>
                                        </h3>
                                        <p className="text-slate-400 text-xs max-w-xs leading-relaxed hidden sm:block">
                                            Ajude a manter Maestrias e Vilas atualizadas para auxiliar na verificação manual do Bingo Book.
                                        </p>
                                    </div>
                                </div>
                                
                                <a 
                                    href="https://forms.gle/tXdA12vpgozjm2G4A" 
                                    target="_blank" 
                                    rel="noopener noreferrer"
                                    className="z-10 px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold rounded-lg transition-all shadow-md shadow-blue-900/20 hover:shadow-blue-900/40 hover:-translate-y-0.5 flex items-center gap-2 whitespace-nowrap"
                                >
                                    <span>Responder Formulário</span>
                                    <ArrowRight className="w-3 h-3" />
                                </a>
                                
                                <div className="absolute -right-6 -top-6 w-24 h-24 bg-blue-500/10 rounded-full blur-2xl pointer-events-none group-hover:bg-blue-500/20 transition-colors duration-500"></div>
                            </div>
                        </div>

                        {/* BARRA DE BUSCA EM DESTAQUE */}
                        <div className="w-full">
                            <div className="relative group w-full">
                                <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                    <Search className="w-6 h-6 text-slate-500 group-focus-within:text-yellow-500 transition-colors" />
                                </div>
                                <input 
                                    type="text" 
                                    placeholder="Buscar jogador..." 
                                    className="w-full bg-slate-900 border border-slate-800 text-slate-200 rounded-xl py-4 pl-12 pr-4 focus:outline-none focus:ring-2 focus:ring-yellow-500/50 focus:border-yellow-500 transition-all shadow-lg text-lg"
                                    value={searchTerm}
                                    onChange={(e) => { setSearchTerm(e.target.value); setCurrentPage(1); }}
                                />
                            </div>
                        </div>

                        {/* Menu de Navegação Principal */}
                        <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                            <button 
                                onClick={() => setViewMode('ranking')}
                                className={`px-5 py-3 rounded-lg font-bold text-sm transition-colors flex items-center gap-2 whitespace-nowrap ${
                                    viewMode === 'ranking' ? 'bg-yellow-500 text-slate-900 shadow-lg shadow-yellow-500/20' : 'bg-slate-800 text-slate-400 hover:bg-slate-700 hover:text-white'
                                }`}
                            >
                                <Trophy className="w-4 h-4" /> Ranking
                            </button>
                            {/* ADICIONADO: Botão Versus */}
                            <button 
                                onClick={() => setViewMode('versus')}
                                className={`px-5 py-3 rounded-lg font-bold text-sm transition-colors flex items-center gap-2 whitespace-nowrap ${
                                    viewMode === 'versus' ? 'bg-yellow-500 text-slate-900 shadow-lg shadow-yellow-500/20' : 'bg-slate-800 text-slate-400 hover:bg-slate-700 hover:text-white'
                                }`}
                            >
                                <Swords className="w-4 h-4" /> Versus
                            </button>
                            <button 
                                onClick={() => setViewMode('tournaments')}
                                className={`px-5 py-3 rounded-lg font-bold text-sm transition-colors flex items-center gap-2 whitespace-nowrap ${
                                    viewMode === 'tournaments' ? 'bg-yellow-500 text-slate-900 shadow-lg shadow-yellow-500/20' : 'bg-slate-800 text-slate-400 hover:bg-slate-700 hover:text-white'
                                }`}
                            >
                                <GitBranch className="w-4 h-4" /> Torneios
                            </button>
                            <button 
                                onClick={() => setViewMode('masteries')}
                                className={`px-5 py-3 rounded-lg font-bold text-sm transition-colors flex items-center gap-2 whitespace-nowrap ${
                                    viewMode === 'masteries' ? 'bg-yellow-500 text-slate-900 shadow-lg shadow-yellow-500/20' : 'bg-slate-800 text-slate-400 hover:bg-slate-700 hover:text-white'
                                }`}
                            >
                                <BookOpen className="w-4 h-4" /> Maestrias
                            </button>
                            <button 
                                onClick={() => setViewMode('villages')}
                                className={`px-5 py-3 rounded-lg font-bold text-sm transition-colors flex items-center gap-2 whitespace-nowrap ${
                                    viewMode === 'villages' ? 'bg-yellow-500 text-slate-900 shadow-lg shadow-yellow-500/20' : 'bg-slate-800 text-slate-400 hover:bg-slate-700 hover:text-white'
                                }`}
                            >
                                <MapIcon className="w-4 h-4" /> Vilas
                            </button>
                        </div>

                        {/* Abas de Modos E Filtros de Data */}
                        <div className="flex flex-col gap-3 pb-2 border-b border-slate-800">
                            <div className="flex flex-wrap items-center gap-2">
                                {/* Lado Esquerdo: Modos */}
                                <div className="flex flex-wrap gap-2">
                                    {modeGroups.main.map(mode => (
                                        <button
                                            key={mode}
                                            onClick={() => { setActiveTab(mode); setShowOtherModes(false); }}
                                            className={`px-4 py-2 rounded-lg text-sm font-bold whitespace-nowrap transition-all flex items-center gap-2 ${
                                                activeTab === mode 
                                                    ? 'bg-blue-600 text-white shadow-md' 
                                                    : 'bg-slate-800 text-slate-400 hover:bg-slate-700 hover:text-white'
                                            }`}
                                        >
                                            {mode === 'Geral' ? <Filter className="w-3.5 h-3.5" /> : 
                                            mode === 'Ranked' ? <ShieldCheck className="w-3.5 h-3.5" /> :
                                            <Swords className="w-3.5 h-3.5" />}
                                            {mode}
                                        </button>
                                    ))}

                                    {modeGroups.others.length > 0 && (
                                        <div className="relative">
                                            <button
                                                onClick={() => setShowOtherModes(!showOtherModes)}
                                                className={`px-4 py-2 rounded-lg text-sm font-bold whitespace-nowrap transition-all flex items-center gap-2 ${
                                                    modeGroups.others.includes(activeTab) 
                                                        ? 'bg-blue-600 text-white shadow-md' 
                                                        : 'bg-slate-800 text-slate-400 hover:bg-slate-700 hover:text-white'
                                                }`}
                                            >
                                                <Menu className="w-3.5 h-3.5" />
                                                {modeGroups.others.includes(activeTab) ? activeTab : "Outros"}
                                                <ChevronDown className={`w-3.5 h-3.5 transition-transform ${showOtherModes ? 'rotate-180' : ''}`} />
                                            </button>

                                            {showOtherModes && (
                                                <div className="absolute top-full left-0 mt-2 w-48 bg-slate-900 border border-slate-800 rounded-xl shadow-xl z-20 overflow-hidden animate-in fade-in slide-in-from-top-2 duration-200">
                                                    {modeGroups.others.map(mode => (
                                                        <button
                                                            key={mode}
                                                            onClick={() => { setActiveTab(mode); setShowOtherModes(false); }}
                                                            className={`w-full text-left px-4 py-3 text-sm font-medium transition-colors hover:bg-slate-800 ${
                                                                activeTab === mode ? 'text-yellow-500 bg-slate-800/50' : 'text-slate-400 hover:text-white'
                                                            }`}
                                                        >
                                                            {mode}
                                                        </button>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>

                                {/* Lado Direito: Filtros de Data */}
                                <div className="flex flex-row items-center gap-2 ml-auto">
                                    <div className="relative group w-40 sm:w-48">
                                        <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <Calendar className="w-4 h-4 text-slate-500" />
                                        </div>
                                        <select 
                                            value={timeFilter}
                                            onChange={(e) => setTimeFilter(e.target.value)}
                                            className="appearance-none w-full bg-slate-900 border border-slate-800 text-slate-200 rounded-lg py-2 pl-9 pr-8 focus:outline-none focus:ring-2 focus:ring-blue-500/50 cursor-pointer hover:bg-slate-800 transition-colors text-sm font-medium"
                                        >
                                            <option value="current_month">Este Mês</option>
                                            <option value="day">Últimas 24h</option>
                                            <option value="week">Última Semana</option>
                                            <option value="specific_month">Selecionar Mês</option>
                                            <option value="all">Todo o Período</option>
                                        </select>
                                        <div className="absolute inset-y-0 right-0 pr-2 flex items-center pointer-events-none">
                                            <ChevronDown className="w-4 h-4 text-slate-500" />
                                        </div>
                                    </div>

                                    {timeFilter === 'specific_month' && availableMonths.length > 0 && (
                                        <div className="relative group w-32 sm:w-40 animate-in fade-in slide-in-from-left-2 duration-200">
                                            <select 
                                                value={targetMonth}
                                                onChange={(e) => setTargetMonth(e.target.value)}
                                                className="appearance-none w-full bg-slate-800 border border-slate-700 text-slate-200 rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500/50 cursor-pointer text-sm font-medium"
                                            >
                                                {availableMonths.map(monthStr => {
                                                    const [year, month] = monthStr.split('-');
                                                    return (
                                                        <option key={monthStr} value={monthStr}>
                                                            {`${month}/${year}`}
                                                        </option>
                                                    );
                                                })}
                                            </select>
                                            <div className="absolute inset-y-0 right-0 pr-2 flex items-center pointer-events-none">
                                                <ChevronDown className="w-3 h-3 text-slate-500" />
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                            
                            <div className="text-slate-400 text-sm flex items-start gap-2 pl-1 animate-in fade-in duration-300">
                                <InfoIcon className="w-4 h-4 mt-0.5 text-slate-500 flex-shrink-0" />
                                <p>{MODE_DESCRIPTIONS[activeTab] || MODE_DESCRIPTIONS['Default']}</p>
                            </div>
                        </div>

                        {/* --- RENDERIZAÇÃO CONDICIONAL POR VIEW --- */}
                        
                        {/* ADICIONADO: VIEW VERSUS */}
                        {viewMode === 'versus' && (
                            <div className="bg-slate-900 rounded-2xl shadow-xl overflow-hidden border border-slate-800 animate-in fade-in slide-in-from-bottom-4 duration-500 p-6">
                                <div className="flex flex-col md:flex-row gap-4 items-end mb-8">
                                    <div className="flex-1 w-full">
                                        <label className="block text-slate-400 text-sm font-bold mb-2">Jogador 1</label>
                                        <div className="relative">
                                             <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                <Users className="w-5 h-5 text-blue-400" />
                                            </div>
                                            <input 
                                                type="text" 
                                                list="playerList"
                                                className="w-full bg-slate-800 border border-slate-700 text-white rounded-xl py-3 pl-10 pr-4 focus:outline-none focus:ring-2 focus:ring-blue-500/50"
                                                placeholder="Nome do Jogador 1"
                                                value={versusPlayer1}
                                                onChange={(e) => setVersusPlayer1(e.target.value)}
                                            />
                                        </div>
                                    </div>
                                    
                                    <div className="flex items-center justify-center pb-3">
                                        <div className="bg-slate-800 p-2 rounded-full border border-slate-700">
                                            <Swords className="w-6 h-6 text-red-500" />
                                        </div>
                                    </div>

                                    <div className="flex-1 w-full">
                                        <label className="block text-slate-400 text-sm font-bold mb-2">Jogador 2</label>
                                        <div className="relative">
                                             <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                <Users className="w-5 h-5 text-red-400" />
                                            </div>
                                            <input 
                                                type="text" 
                                                list="playerList"
                                                className="w-full bg-slate-800 border border-slate-700 text-white rounded-xl py-3 pl-10 pr-4 focus:outline-none focus:ring-2 focus:ring-red-500/50"
                                                placeholder="Nome do Jogador 2"
                                                value={versusPlayer2}
                                                onChange={(e) => setVersusPlayer2(e.target.value)}
                                            />
                                        </div>
                                    </div>
                                    
                                    <datalist id="playerList">
                                        {data.rankings.map(p => <option key={p.name} value={p.name} />)}
                                    </datalist>
                                </div>

                                {versusMatches.length > 0 ? (
                                    <>
                                        {/* Comparativo Visual */}
                                        <div className="mb-8 space-y-4">
                                            {/* Wins Bar */}
                                            <div className="flex items-center gap-3">
                                                <span className="text-xs text-blue-400 font-bold w-12 text-right">{((versusStats.p1Wins/versusStats.total)*100).toFixed(0)}%</span>
                                                <div className="flex-1 h-2 bg-slate-800 rounded-full overflow-hidden flex">
                                                    <div style={{ width: `${(versusStats.p1Wins/versusStats.total)*100}%` }} className="h-full bg-blue-500"></div>
                                                    <div style={{ width: `${(versusStats.p2Wins/versusStats.total)*100}%` }} className="h-full bg-red-500"></div>
                                                </div>
                                                <span className="text-xs text-red-400 font-bold w-12">{((versusStats.p2Wins/versusStats.total)*100).toFixed(0)}%</span>
                                            </div>
                                        </div>

                                        {/* Placar */}
                                        <div className="flex justify-center items-center gap-8 mb-8">
                                            <div className="text-center">
                                                <div className="text-4xl font-black text-blue-500">{versusStats.p1Wins}</div>
                                                <div className="text-xs text-slate-400 font-bold uppercase tracking-wider">{versusPlayer1}</div>
                                            </div>
                                            <div className="text-slate-600 text-2xl font-black">X</div>
                                            <div className="text-center">
                                                <div className="text-4xl font-black text-red-500">{versusStats.p2Wins}</div>
                                                <div className="text-xs text-slate-400 font-bold uppercase tracking-wider">{versusPlayer2}</div>
                                            </div>
                                        </div>

                                        {/* Lista de Partidas */}
                                        <div className="space-y-3">
                                            {versusMatches.map((match, idx) => {
                                                const m = match.content.match(/^\[(.*?)\] (.*?) derrotou (.*)/);
                                                const winners = m ? m[2].split(',').map(n => n.trim()) : [];
                                                const isP1Winner = winners.includes(versusPlayer1);

                                                return (
                                                    <div key={idx} className={`p-4 rounded-xl border flex justify-between items-center ${isP1Winner ? 'bg-blue-900/10 border-blue-500/20' : 'bg-red-900/10 border-red-500/20'}`}>
                                                        <div className="flex flex-col">
                                                            <span className="text-[10px] font-bold uppercase tracking-wider text-slate-500 mb-1">{match.content.match(/^\[(.*?)\]/)[1]}</span>
                                                            <div className="font-bold text-slate-200">
                                                                <span className={isP1Winner ? 'text-blue-400' : 'text-slate-400'}>{versusPlayer1}</span>
                                                                <span className="mx-2 text-slate-600 text-xs">vs</span>
                                                                <span className={!isP1Winner ? 'text-red-400' : 'text-slate-400'}>{versusPlayer2}</span>
                                                            </div>
                                                        </div>
                                                        <div className="text-right">
                                                            <div className={`text-sm font-black ${isP1Winner ? 'text-blue-500' : 'text-red-500'}`}>
                                                                {isP1Winner ? 'VITÓRIA' : 'DERROTA'}
                                                            </div>
                                                            <div className="text-xs text-slate-500 mt-1">
                                                                {new Date(match.timestamp).toLocaleDateString('pt-BR')}
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </>
                                ) : (
                                    (versusPlayer1 && versusPlayer2) && (
                                        <div className="text-center py-12 text-slate-500 border border-dashed border-slate-800 rounded-xl">
                                            <Swords className="w-12 h-12 mx-auto mb-3 opacity-20" />
                                            <p>Nenhum confronto encontrado entre estes jogadores.</p>
                                        </div>
                                    )
                                )}
                            </div>
                        )}
                        
                        {viewMode === 'ranking' && (
                            <>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                    <Card title="Jogadores Ativos" value={filteredRankings.length} icon={Users} colorClass="text-blue-400 bg-blue-500" />
                                    <Card title="Batalhas Totais" value={totalBattles} icon={Swords} colorClass="text-red-400 bg-red-500" />
                                    <Card title="Mais Vitórias" value={mostWinsPlayer ? mostWinsPlayer.name : '-'} icon={Medal} colorClass="text-yellow-400 bg-yellow-500" />
                                    <Card title="Mais Derrotas" value={mostLossesPlayer ? mostLossesPlayer.name : '-'} icon={TrendingDown} colorClass="text-orange-400 bg-orange-500" />
                                </div>

                                <div className="bg-slate-900 rounded-2xl shadow-xl overflow-hidden border border-slate-800">
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-left border-collapse">
                                            <thead>
                                                <tr className="bg-slate-950/50 border-b border-slate-800 text-slate-400 text-xs font-bold uppercase tracking-wider">
                                                    <th className="p-5 w-20 text-center">#</th>
                                                    <th className="p-5 cursor-pointer hover:text-white transition-colors" onClick={() => handleSort('name')}>Jogador</th>
                                                    <th className="p-5 text-center cursor-pointer hover:text-yellow-400 transition-colors" onClick={() => handleSort('wins')}>Vitórias</th>
                                                    <th className="p-5 text-center cursor-pointer hover:text-red-400 transition-colors" onClick={() => handleSort('losses')}>Derrotas</th>
                                                    <th className="p-5 text-center cursor-pointer hover:text-blue-400 transition-colors" onClick={() => handleSort('battles')}>Partidas</th>
                                                    <th className="p-5 text-center cursor-pointer hover:text-green-400 transition-colors" onClick={() => handleSort('winRate')}>Win Rate</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-800">
                                                {paginatedRankings.map((player, index) => {
                                                    let rankColor = "text-slate-500";
                                                    let rankIcon = null;
                                                    // Ajuste do Rank para considerar a página
                                                    const realRank = (currentPage - 1) * ITEMS_PER_PAGE + index + 1;

                                                    if (realRank === 1) { rankColor = "text-yellow-500"; rankIcon = <Trophy className="w-4 h-4 mx-auto" />; }
                                                    if (realRank === 2) { rankColor = "text-slate-300"; rankIcon = <Medal className="w-4 h-4 mx-auto" />; }
                                                    if (realRank === 3) { rankColor = "text-amber-700"; rankIcon = <Medal className="w-4 h-4 mx-auto" />; }

                                                    // Verificar se há dados
                                                    const hasData = player.meta && (player.meta.village || player.meta.mastery_1);

                                                    return (
                                                        <tr key={player.name} onClick={() => setSelectedPlayer(player)} className="hover:bg-slate-800/50 cursor-pointer transition-colors group">
                                                            <td className={`p-5 text-center font-bold ${rankColor} text-lg`}>{rankIcon || `#${realRank}`}</td>
                                                            <td className="p-5">
                                                                <div className="flex flex-col">
                                                                    <div className="flex items-center gap-2">
                                                                        <span className="font-semibold text-white group-hover:text-yellow-400 transition-colors text-lg">{player.name}</span>
                                                                        
                                                                        {/* Streak Icons */}
                                                                        {player.streak >= 3 && <span title={`${player.streak} vitórias seguidas`}><Flame className="w-4 h-4 text-orange-500 animate-pulse" /></span>}
                                                                        {player.streak <= -3 && <span title={`${Math.abs(player.streak)} derrotas seguidas`}><Skull className="w-4 h-4 text-slate-500" /></span>}
                                                                        
                                                                        {/* Badges */}
                                                                        {player.badges.map(b => (
                                                                            <b.icon key={b.id} className={`w-3.5 h-3.5 ${b.color}`} title={b.label} />
                                                                        ))}
                                                                    </div>

                                                                    {hasData ? (
                                                                        <div className="flex flex-wrap gap-1 mt-1">
                                                                            {player.meta.village && (
                                                                                <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded border border-slate-700 bg-slate-800/50 uppercase tracking-wide ${STYLE_MAP[player.meta.village] || 'text-slate-400'}`}>
                                                                                    {player.meta.village}
                                                                                </span>
                                                                            )}
                                                                            {player.meta.mastery_1 && (
                                                                                <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded border uppercase tracking-wide ${STYLE_MAP[player.meta.mastery_1] || 'bg-slate-800 text-slate-400 border-slate-700'}`}>
                                                                                    {player.meta.mastery_1}
                                                                                </span>
                                                                            )}
                                                                            {player.meta.mastery_2 && (
                                                                                <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded border uppercase tracking-wide ${STYLE_MAP[player.meta.mastery_2] || 'bg-slate-800 text-slate-400 border-slate-700'}`}>
                                                                                    {player.meta.mastery_2}
                                                                                </span>
                                                                            )}
                                                                        </div>
                                                                    ) : (
                                                                        <span className="text-[10px] text-slate-600 bg-slate-900/50 px-2 py-0.5 rounded border border-slate-800 w-fit mt-1">Sem Registro</span>
                                                                    )}
                                                                </div>
                                                            </td>
                                                            <td className="p-5 text-center font-bold text-slate-200">{player.wins}</td>
                                                            <td className="p-5 text-center font-medium text-slate-500">{player.losses}</td>
                                                            <td className="p-5 text-center text-slate-400">{player.battles}</td>
                                                            <td className="p-5 text-center">
                                                                <div className="flex flex-col items-center gap-1">
                                                                    <span className={`text-xs font-bold px-2 py-1 rounded-full ${
                                                                        parseFloat(player.winRate) >= 60 ? 'bg-green-500/20 text-green-400' : 
                                                                        parseFloat(player.winRate) >= 40 ? 'bg-yellow-500/20 text-yellow-400' : 
                                                                        'bg-red-500/20 text-red-400'
                                                                    }`}>{player.winRate}%</span>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    );
                                                })}
                                                {filteredRankings.length === 0 && (
                                                    <tr>
                                                        <td colSpan="6" className="p-12 text-center text-slate-500">
                                                            <div className="flex flex-col items-center gap-3">
                                                                <Users className="w-12 h-12 text-slate-700" />
                                                                <p>Nenhum jogador encontrado para este filtro.</p>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                )}
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    {/* CONTROLES DE PAGINAÇÃO */}
                                    {totalPages > 1 && (
                                        <div className="p-4 border-t border-slate-800 flex justify-center items-center gap-4 bg-slate-900">
                                            <button 
                                                onClick={() => setCurrentPage(prev => Math.max(prev - 1, 1))}
                                                disabled={currentPage === 1}
                                                className="p-2 rounded-lg bg-slate-800 hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed text-slate-400 transition-colors"
                                            >
                                                <ChevronLeft className="w-5 h-5" />
                                            </button>
                                            <span className="text-sm text-slate-400 font-medium">
                                                Página <span className="text-white font-bold">{currentPage}</span> de {totalPages}
                                            </span>
                                            <button 
                                                onClick={() => setCurrentPage(prev => Math.min(prev + 1, totalPages))}
                                                disabled={currentPage === totalPages}
                                                className="p-2 rounded-lg bg-slate-800 hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed text-slate-400 transition-colors"
                                            >
                                                <ChevronRight className="w-5 h-5" />
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </>
                        )}
                        
                        {/* (Manter outros views: tournaments, masteries, villages inalterados exceto a parte lógica que já foi atualizada nos useMemos) */}
                        {/* Código das outras views (Tournaments, Masteries, Villages) permanece o mesmo pois usam useMemos que se atualizam automaticamente com os novos dados */}
                        {viewMode === 'tournaments' && (
                            <div className="bg-slate-900 rounded-2xl shadow-xl overflow-hidden border border-slate-800 animate-in fade-in slide-in-from-bottom-4 duration-500">
                                <div className="overflow-x-auto">
                                    <table className="w-full text-left border-collapse">
                                        <thead>
                                            <tr className="bg-slate-950/50 border-b border-slate-800 text-slate-400 text-xs font-bold uppercase tracking-wider">
                                                <th className="p-5">Data</th>
                                                <th className="p-5">Torneio</th>
                                                <th className="p-5 text-center">Partidas</th>
                                                <th className="p-5 text-right">Horário</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-800">
                                            {Object.entries(tournamentsByDate).map(([date, tournaments]) => (
                                                <React.Fragment key={date}>
                                                    <tr className="bg-slate-900/80 border-b border-slate-800">
                                                        <td colSpan="4" className="p-3 px-5 text-yellow-500 font-bold text-xs uppercase tracking-wider sticky top-0 bg-slate-950/90 backdrop-blur-sm z-10">
                                                            {date}
                                                        </td>
                                                    </tr>
                                                    {tournaments.map(tournament => (
                                                        <tr 
                                                            key={tournament.id} 
                                                            onClick={() => setSelectedTournament(tournament)}
                                                            className="hover:bg-slate-800/50 cursor-pointer transition-colors group"
                                                        >
                                                            <td className="p-5 text-slate-400 font-mono text-sm">
                                                                <div className="flex items-center gap-2">
                                                                    <Calendar className="w-4 h-4 text-slate-600" />
                                                                    {tournament.date}
                                                                </div>
                                                            </td>
                                                            <td className="p-5 font-bold text-white group-hover:text-yellow-400 transition-colors text-lg">
                                                                {tournament.name}
                                                            </td>
                                                            <td className="p-5 text-center text-slate-400">
                                                                <span className="bg-slate-800 px-3 py-1 rounded-full text-xs font-bold border border-slate-700">
                                                                    {tournament.matches.length} partidas
                                                                </span>
                                                            </td>
                                                            <td className="p-5 text-right text-slate-500 group-hover:text-white transition-colors">
                                                                <div className="flex items-center justify-end gap-2 font-mono text-sm">
                                                                    <Clock className="w-4 h-4 text-slate-600" />
                                                                    {getRoundedTime(tournament.timestamp)}
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </React.Fragment>
                                            ))}
                                            {groupedTournaments.length === 0 && (
                                                <tr>
                                                    <td colSpan="4" className="p-12 text-center text-slate-500">
                                                        <div className="flex flex-col items-center gap-3">
                                                            <Trophy className="w-12 h-12 text-slate-700 opacity-50" />
                                                            <p>Nenhum torneio encontrado para este filtro.</p>
                                                        </div>
                                                    </td>
                                                </tr>
                                            )}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {viewMode === 'masteries' && (
                            <div className="bg-slate-900 rounded-2xl shadow-xl overflow-hidden border border-slate-800 animate-in fade-in slide-in-from-bottom-4 duration-500">
                                <div className="bg-slate-900/50 border-b border-yellow-500/20 px-6 py-3 flex items-start gap-3">
                                    <AlertCircle className="w-5 h-5 text-yellow-500 flex-shrink-0 mt-0.5" />
                                    <p className="text-xs text-slate-400 leading-relaxed">
                                        <strong className="text-yellow-500 block mb-1">Atenção: Dados Manuais</strong>
                                        Os dados desta seção são atualizados manualmente consultando o Bingo Book. 
                                        Podem ocorrer desatualizações devido a resets de conta ou mudanças de vila. 
                                        Caso encontre erros, avise no Discord. A lista será atualizada com o tempo.
                                    </p>
                                </div>
                                <div className="p-6 border-b border-slate-800 flex justify-between items-center">
                                    <div>
                                        <h3 className="text-xl font-bold text-white">Ranking de Maestrias</h3>
                                        <p className="text-slate-400 text-sm">Estatísticas acumuladas por maestria.</p>
                                    </div>
                                    <div className="flex bg-slate-800 p-1 rounded-lg border border-slate-700">
                                        <button onClick={() => setMasteryViewMode('combined')} className={`px-3 py-1.5 rounded text-xs font-bold transition-colors ${masteryViewMode === 'combined' ? 'bg-blue-600 text-white shadow-sm' : 'text-slate-400 hover:text-white'}`}>Combinadas</button>
                                        <button onClick={() => setMasteryViewMode('individual')} className={`px-3 py-1.5 rounded text-xs font-bold transition-colors ${masteryViewMode === 'individual' ? 'bg-blue-600 text-white shadow-sm' : 'text-slate-400 hover:text-white'}`}>Individuais</button>
                                    </div>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-left border-collapse">
                                        <thead>
                                            <tr className="bg-slate-950/50 border-b border-slate-800 text-slate-400 text-xs font-bold uppercase tracking-wider">
                                                <th className="p-5">#</th>
                                                <th className="p-5">Maestria</th>
                                                <th className="p-5 text-center">Jogadores Ativos</th>
                                                <th className="p-5 text-center">Total Vitórias</th>
                                                <th className="p-5 text-center">Derrotas</th>
                                                <th className="p-5 text-center">Partidas</th>
                                                <th className="p-5 text-center">Win Rate</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-800">
                                            {groupedMasteries.map((m, idx) => (
                                                <tr key={m.name} className="hover:bg-slate-800/50 transition-colors cursor-pointer group" onClick={() => handleMasteryClick(m.name)} title="Clique para ver os jogadores com esta maestria">
                                                    <td className="p-5 text-slate-500 font-bold">{idx + 1}</td>
                                                    <td className="p-5">
                                                        <div className="flex flex-wrap gap-2">
                                                            {m.parts.map((part, i) => (
                                                                <span key={i} className={`text-sm font-bold px-3 py-1 rounded border uppercase tracking-wide group-hover:brightness-110 ${STYLE_MAP[part] || 'text-slate-200 border-slate-700'}`}>{part}</span>
                                                            ))}
                                                        </div>
                                                    </td>
                                                    <td className="p-5 text-center text-slate-300 font-bold group-hover:text-white">{m.players}</td>
                                                    <td className="p-5 text-center text-yellow-500 font-bold">{m.wins}</td>
                                                    <td className="p-5 text-center text-red-500 font-bold">{m.losses}</td>
                                                    <td className="p-5 text-center text-blue-400 font-bold">{m.battles}</td>
                                                    <td className="p-5 text-center">
                                                     <span className={`text-xs font-bold px-2 py-1 rounded-full ${parseFloat(m.winRate) >= 60 ? 'bg-green-500/20 text-green-400' : parseFloat(m.winRate) >= 40 ? 'bg-yellow-500/20 text-yellow-400' : 'bg-red-500/20 text-red-400'}`}>{m.winRate}%</span>
                                                    </td>
                                                </tr>
                                            ))}
                                            {groupedMasteries.length === 0 && (<tr><td colSpan="7" className="p-8 text-center text-slate-500">Nenhum dado de maestria encontrado.</td></tr>)}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {viewMode === 'villages' && (
                            <div className="bg-slate-900 rounded-2xl shadow-xl overflow-hidden border border-slate-800 animate-in fade-in slide-in-from-bottom-4 duration-500">
                                <div className="bg-slate-900/50 border-b border-yellow-500/20 px-6 py-3 flex items-start gap-3">
                                    <AlertCircle className="w-5 h-5 text-yellow-500 flex-shrink-0 mt-0.5" />
                                    <p className="text-xs text-slate-400 leading-relaxed"><strong className="text-yellow-500 block mb-1">Atenção: Dados Manuais</strong>Os dados desta seção são atualizados manualmente consultando o Bingo Book. Podem ocorrer desatualizações devido a resets de conta ou mudanças de vila. Caso encontre erros, avise no Discord. A lista será atualizada com o tempo.</p>
                                </div>
                                <div className="p-6 border-b border-slate-800">
                                    <h3 className="text-xl font-bold text-white">Ranking de Vilas</h3>
                                    <p className="text-slate-400 text-sm">Estatísticas acumuladas por vila.</p>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-left border-collapse">
                                        <thead>
                                            <tr className="bg-slate-950/50 border-b border-slate-800 text-slate-400 text-xs font-bold uppercase tracking-wider">
                                                <th className="p-5">#</th>
                                                <th className="p-5">Vila</th>
                                                <th className="p-5 text-center">Jogadores Ativos</th>
                                                <th className="p-5 text-center">Total Vitórias</th>
                                                <th className="p-5 text-center">Derrotas</th>
                                                <th className="p-5 text-center">Partidas</th>
                                                <th className="p-5 text-center">Win Rate</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-800">
                                            {groupedVillages.map((v, idx) => (
                                                <tr key={v.name} className="hover:bg-slate-800/50 transition-colors cursor-pointer group" onClick={() => handleVillageClick(v.name)} title="Clique para ver os jogadores desta vila">
                                                    <td className="p-5 text-slate-500 font-bold">{idx + 1}</td>
                                                    <td className="p-5 font-bold text-lg"><span className={STYLE_MAP[v.name] || 'text-white'}>{v.name}</span></td>
                                                    <td className="p-5 text-center text-slate-300 font-bold">{v.players}</td>
                                                    <td className="p-5 text-center text-yellow-500 font-bold">{v.wins}</td>
                                                    <td className="p-5 text-center text-red-500 font-bold">{v.losses}</td>
                                                    <td className="p-5 text-center text-blue-400 font-bold">{v.battles}</td>
                                                    <td className="p-5 text-center"><span className={`text-xs font-bold px-2 py-1 rounded-full ${parseFloat(v.winRate) >= 60 ? 'bg-green-500/20 text-green-400' : parseFloat(v.winRate) >= 40 ? 'bg-yellow-500/20 text-yellow-400' : 'bg-red-500/20 text-red-400'}`}>{v.winRate}%</span></td>
                                                </tr>
                                            ))}
                                            {groupedVillages.length === 0 && (<tr><td colSpan="7" className="p-8 text-center text-slate-500">Nenhum dado de vila encontrado.</td></tr>)}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                        
                        {/* FOOTER DISCRETO PARA DEBUG */}
                        <div className="text-center text-[10px] text-slate-700 mt-8 pb-4">
                            Arquivos carregados: {loadedFilesCount}
                        </div>

                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
